{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2>Detalle de la Carrera</h2>
    <nav>
        <ul>
            <li><a href="{% url 'home' %}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a></li>
        </ul>
    </nav>
    <div id="map" style="height: 400px;"></div>

    <div class="mt-3">
        <h3>Informaci√≥n de la Carrera</h3>
        <p><strong>Origen:</strong> {{ ride.origin }}</p>
        <p><strong>Precio:</strong> ${{ ride.price }}</p>
        <p><strong>Estado:</strong> {{ ride.status }}</p>
        <p><strong>Destinos:</strong></p>
        <ul>
            {% for destination in ride.destinations.all %}
            <li>{{ destination.destination }}</li>
            {% endfor %}
        </ul>
    </div>

    {% if request.user == ride.customer or request.user.is_superuser %}
    <!-- Informaci√≥n que ver√° el cliente o el administrador -->
    <h3>Informaci√≥n del Conductor</h3>
    {% if ride.driver %}
    <p><strong>Nombre:</strong> {{ ride.driver.username }}</p>
    <p><strong>Email:</strong> {{ ride.driver.email }}</p>
    <p><strong>Tel√©fono:</strong> {{ ride.driver.phone_number }}</p>
    
    <!-- Chat con el conductor (solo si el viaje est√° en progreso) -->
    {% if ride.status == 'in_progress' %}
    <div class="mt-4">
        <h4>üí¨ Chat con el Conductor</h4>
        <div id="chat-container" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;">
            <div id="chat-log" style="height: 300px; overflow-y: auto; margin-bottom: 15px; padding: 10px; background: white; border-radius: 8px;">
                <!-- Los mensajes aparecer√°n aqu√≠ -->
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="chat-input" placeholder="Escribe un mensaje..." 
                       style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                <button onclick="sendMessage()" class="btn btn-primary">Enviar</button>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <p>A√∫n no se ha asignado un conductor a esta carrera.</p>
    {% endif %}

    <!-- Mostrar el taxi del cliente en el mapa -->
    {% if ride.customer.taxi %}
    <h4>Taxi del Cliente</h4>
    <p><strong>Placa:</strong> {{ ride.customer.taxi.plate_number }}</p>
    <p><strong>Descripci√≥n:</strong> {{ ride.customer.taxi.vehicle_description }}</p>
    {% endif %}
    {% endif %}

    {% if request.user == ride.driver or request.user.is_superuser %}
    <!-- Informaci√≥n que ver√° el conductor o el administrador -->
    <h3>Informaci√≥n del Cliente</h3>
    <p><strong>Nombre:</strong> {{ ride.customer.username }}</p>
    <p><strong>Email:</strong> {{ ride.customer.email }}</p>
    <p><strong>Tel√©fono:</strong> {{ ride.customer.phone_number }}</p>

    <!-- Mostrar la ubicaci√≥n del taxi del cliente en el mapa -->
    {% if ride.customer.taxi %}
    <h4>Taxi del Cliente</h4>
    <p><strong>Placa:</strong> {{ ride.customer.taxi.plate_number }}</p>
    <p><strong>Descripci√≥n:</strong> {{ ride.customer.taxi.vehicle_description }}</p>
    {% endif %}

    <!-- Botones para acciones del conductor (solo si la carrera no ha sido cancelada ni completada) -->
    {% if ride.status != 'canceled' and ride.status != 'completed' %}
    <div class="mt-3">
        <h4>Acciones</h4>
        <form method="post" action="{% url 'ride_cancel' ride.id %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Cancelar Carrera</button>
        </form>
        <form method="post" action="{% url 'ride_complete' ride.id %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">Marcar como Completada</button>
        </form>
    </div>
    {% endif %}
    {% endif %}
</div>

<!-- Script de Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAtEPZgbPBwnJGrvIuwplRJDFbr0tmbnyQ&libraries=places&callback=initMap"
    async defer></script>

<script>
    let map;
    let driverMarker = null; // Marcador del conductor que se actualizar√° en tiempo real
    let driverInfoWindow = null;
    let locationSocket = null;

    function initMap() {
        // Inicializar el mapa
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: {{ ride.origin_latitude }}, lng: {{ ride.origin_longitude }} },
            zoom: 14,
        });

        // Coordenadas del origen
        const originLatLng = { lat: {{ ride.origin_latitude }}, lng: {{ ride.origin_longitude }} };
        new google.maps.Marker({
            position: originLatLng,
            map: map,
            title: 'Origen',
            icon: {
                url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
            }
        });

        // Coordenadas del cliente (si aplica)
        {% if ride.customer_latitude and ride.customer_longitude %}
        const customerLatLng = { lat: {{ ride.customer_latitude }}, lng: {{ ride.customer_longitude }} };
        new google.maps.Marker({
            position: customerLatLng,
            map: map,
            title: 'Cliente',
            icon: {
                url: 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'
            }
        });
        {% endif %}

        // Coordenadas iniciales del conductor (si est√°n disponibles)
        {% if driver_lat and driver_lng %}
        const driverLatLng = { lat: {{ driver_lat }}, lng: {{ driver_lng }} };
        createDriverMarker(driverLatLng);
        {% endif %}

        // Coordenadas de los destinos
        const destinationMarkers = [];
        {% for destination in ride.destinations.all %}
        const destinationLatLng = { lat: {{ destination.destination_latitude }},
                                     lng: {{ destination.destination_longitude }} };
        destinationMarkers.push(destinationLatLng);
        new google.maps.Marker({
            position: destinationLatLng,
            map: map,
            title: 'Destino {{ forloop.counter }}',
            icon: {
                url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
            }
        });
        {% endfor %}

        // Configurar servicio de direcciones
        const directionsService = new google.maps.DirectionsService();
        const directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: 'blue',
                strokeOpacity: 0.7,
                strokeWeight: 5,
            },
        });

        // Configurar waypoints (intermedios)
        const waypoints = destinationMarkers.slice(0, -1).map(location => ({ location }));

        // Generar la ruta
        if (destinationMarkers.length > 0) {
            directionsService.route(
                {
                    origin: originLatLng,
                    destination: destinationMarkers[destinationMarkers.length - 1],
                    waypoints: waypoints,
                    travelMode: 'DRIVING',
                },
                (response, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);
                    } else {
                        console.error('Error al calcular la ruta:', status);
                    }
                }
            );
        } else {
            // Si no hay destinos, al menos mostrar la ruta del conductor al origen
            {% if driver_lat and driver_lng %}
            directionsService.route(
                {
                    origin: { lat: {{ driver_lat }}, lng: {{ driver_lng }} },
                    destination: originLatLng,
                    travelMode: 'DRIVING',
                },
                (response, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);
                    }
                }
            );
            {% endif %}
        }

        // Conectar al WebSocket para recibir ubicaciones en tiempo real
        {% if ride.driver %}
        setupLocationWebSocket();
        {% endif %}
    }

    // Crear o actualizar el marcador del conductor
    function createDriverMarker(position) {
        if (driverMarker) {
            // Si ya existe, solo actualizar posici√≥n
            driverMarker.setPosition(position);
            console.log('üìç Posici√≥n del conductor actualizada:', position);
        } else {
            // Crear nuevo marcador
            driverMarker = new google.maps.Marker({
                position: position,
                map: map,
                title: 'Conductor',
                icon: {
                    url: 'https://maps.google.com/mapfiles/kml/pal2/icon47.png', // Icono de taxi
                    scaledSize: new google.maps.Size(32, 32)
                },
                animation: google.maps.Animation.DROP
            });

            // InfoWindow para el conductor
            driverInfoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 10px;">
                        <h4 style="margin: 0 0 5px 0; color: #333;">üöñ Conductor</h4>
                        <p style="margin: 0; color: #666;"><strong>{{ ride.driver.get_full_name }}</strong></p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">
                            √öltima actualizaci√≥n: <span id="driver-last-update">${new Date().toLocaleTimeString()}</span>
                        </p>
                    </div>
                `
            });

            driverMarker.addListener('click', () => {
                driverInfoWindow.open(map, driverMarker);
            });

            console.log('üìç Marcador del conductor creado:', position);
        }
        
        // Actualizar timestamp en el InfoWindow si est√° abierto
        const timestampElement = document.getElementById('driver-last-update');
        if (timestampElement) {
            timestampElement.textContent = new Date().toLocaleTimeString();
        }
    }

    // Configurar WebSocket para recibir ubicaciones en tiempo real
    function setupLocationWebSocket() {
        // Verificar el estado de la carrera - no conectar si ya est√° completada o cancelada
        const rideStatus = '{{ ride.status }}';
        if (rideStatus === 'completed' || rideStatus === 'canceled') {
            console.log('üìã Carrera finalizada. No se conectar√° al WebSocket para actualizaciones en tiempo real.');
            console.log(`‚ÑπÔ∏è Estado de la carrera: ${rideStatus}`);
            return; // No conectar WebSocket para carreras terminadas
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/comunicacion/`;
        
        console.log('üîå Conectando al WebSocket:', wsUrl);
        console.log(`üìã Estado de la carrera: ${rideStatus} (activa)`);
        
        locationSocket = new WebSocket(wsUrl);

        locationSocket.onopen = function(e) {
            console.log('‚úÖ WebSocket conectado para recibir ubicaciones en tiempo real');
        };

        locationSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('üì• Mensaje WebSocket recibido:', data);

            // Procesar solo actualizaciones de ubicaci√≥n del conductor de esta carrera
            if (data.type === 'driver_location_update' || data.type === 'location_update' || data.type === 'location') {
                const driverId = data.driverId;
                const rideDriverId = '{{ ride.driver.username }}'; // Username del conductor de esta carrera
                
                // Solo actualizar si es el conductor de esta carrera
                if (driverId === rideDriverId || driverId === '{{ ride.driver.id }}') {
                    const lat = parseFloat(data.latitude);
                    const lng = parseFloat(data.longitude);
                    
                    if (lat && lng) {
                        const newPosition = { lat: lat, lng: lng };
                        createDriverMarker(newPosition);
                        console.log(`üìç Ubicaci√≥n del conductor actualizada desde ${data.source || 'WebSocket'}`);
                    }
                }
            }
        };

        locationSocket.onerror = function(e) {
            console.error('‚ùå Error en WebSocket:', e);
        };

        locationSocket.onclose = function(e) {
            console.log('üîå WebSocket cerrado. Intentando reconectar en 5 segundos...');
            // Solo reconectar si la carrera sigue activa
            const currentStatus = '{{ ride.status }}';
            if (currentStatus !== 'completed' && currentStatus !== 'canceled') {
                setTimeout(setupLocationWebSocket, 5000);
            } else {
                console.log('üìã Carrera finalizada. No se reconectar√° al WebSocket.');
            }
        };
    }

    // Limpiar WebSocket al salir de la p√°gina
    window.addEventListener('beforeunload', function() {
        if (locationSocket) {
            locationSocket.close();
        }
    });
</script>

{% endblock %}

