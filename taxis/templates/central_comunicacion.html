{% extends 'base.html' %}
{% load static %}

{% block title %}Central de Comunicación{% endblock %}

{% block content %}
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 200px);
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .user-list {
        width: 30%;
        max-width: 350px;
        border-right: 1px solid #e0e0e0;
        overflow-y: auto;
        background: #f9f9f9;
    }

    .user-list-header, .chat-header {
        padding: 20px;
        font-size: 1.2rem;
        font-weight: 600;
        border-bottom: 1px solid #e0e0e0;
        background: #f1f1f1;
    }

    .user-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        cursor: pointer;
        border-bottom: 1px solid #e9e9e9;
        transition: background-color 0.3s;
    }

    .user-item:hover, .user-item.active {
        background-color: #e6f7ff;
    }

    .user-item img {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 15px;
    }

    .chat-window {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        flex-shrink: 0;
    }

    .chat-messages {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f4f7f9;
    }

    .message {
        display: flex;
        margin-bottom: 15px;
        max-width: 80%;
    }

    .message.sent {
        margin-left: auto;
        flex-direction: row-reverse;
    }

    .message-bubble {
        padding: 12px 18px;
        border-radius: 20px;
        line-height: 1.5;
    }

    .message.sent .message-bubble {
        background: #007bff;
        color: white;
        border-bottom-right-radius: 5px;
    }

    .message.received .message-bubble {
        background: #e9ecef;
        color: #333;
        border-bottom-left-radius: 5px;
    }

    .message-sender {
        font-size: 0.8rem;
        color: #888;
        margin: 0 5px 5px 5px;
    }

    .chat-input-area {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        background: #fff;
        display: flex;
    }

    #chat-message-input {
        flex-grow: 1;
        border: 1px solid #ccc;
        border-radius: 20px;
        padding: 10px 15px;
        font-size: 1rem;
    }

    #chat-message-submit {
        margin-left: 10px;
        border: none;
        background: #007bff;
        color: white;
        font-weight: 600;
        border-radius: 20px;
        padding: 10px 20px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #chat-message-submit:hover {
        background: #0056b3;
    }

    #no-chat-selected {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #888;
        font-size: 1.2rem;
    }
</style>

<div class="chat-container">
    {% if request.user.is_superuser %}
    <div class="user-list">
        <div class="user-list-header">Conductores</div>
        {% for driver in drivers %}
        <div class="user-item" data-driver-id="{{ driver.id }}" data-driver-name="{{ driver.get_full_name }}">
            <img src="{{ driver.profile_picture.url|default:'/static/imagenes/logo1.png' }}" alt="{{ driver.get_full_name }}">
            <span>{{ driver.get_full_name }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="chat-window">
        <div class="chat-header" id="chat-header">Selecciona un chat</div>
        <div class="chat-messages" id="chat-log">
            <div id="no-chat-selected">Selecciona una conversación para comenzar</div>
        </div>
        <div class="chat-input-area" id="chat-input-container" style="display: none;">
            <button id="record-audio-btn" style="margin-right: 10px; background: #28a745; color: white; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer;">🎤 Grabar Audio</button>
            <button id="stop-audio-btn" style="margin-right: 10px; background: #dc3545; color: white; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer; display: none;">⏹️ Detener</button>
            <input id="chat-message-input" type="text" placeholder="Escribe un mensaje...">
            <button id="chat-message-submit">Enviar</button>
        </div>
    </div>
</div>

<audio id="audio-player" style="display: none;"></audio>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentUser = {
        id: "{{ request.user.id }}",
        is_superuser: {{ request.user.is_superuser|yesno:'true,false' }}
    };
    const adminUserId = "{{ admin_user_id }}";

    const chatLog = document.getElementById('chat-log');
    const chatHeader = document.getElementById('chat-header');
    const messageInput = document.getElementById('chat-message-input');
    const messageSubmit = document.getElementById('chat-message-submit');
    const inputContainer = document.getElementById('chat-input-container');
    const noChatSelected = document.getElementById('no-chat-selected');

    let activeChatRecipientId = null;
    let chatSocket = null;

    function setupWebSocket() {
        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const wsPath = wsProtocol + window.location.host + '/ws/chat/';
        
        chatSocket = new WebSocket(wsPath);

        chatSocket.onopen = function(e) {
            console.log('Chat WebSocket conectado.');
        };

        chatSocket.onclose = function(e) {
            console.error('Chat WebSocket desconectado. Reintentando en 5s...');
            setTimeout(setupWebSocket, 5000);
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const { message, sender_id, sender_name } = data;

            // Solo mostrar el mensaje si es parte de la conversación activa
            if (sender_id == activeChatRecipientId || sender_id == currentUser.id) {
                appendMessage(message, sender_id, sender_name);
            }
        };
    }

    function appendMessage(message, sender_id, sender_name) {
        if (noChatSelected) noChatSelected.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        const isSent = sender_id == currentUser.id;
        messageDiv.classList.add(isSent ? 'sent' : 'received');

        messageDiv.innerHTML = `
            <div>
                <div class="message-sender">${isSent ? 'Tú' : sender_name}</div>
                <div class="message-bubble">${message}</div>
            </div>
        `;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && activeChatRecipientId && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': message,
                'recipient_id': activeChatRecipientId
            }));
            messageInput.value = '';
        }
    }

    messageSubmit.addEventListener('click', sendMessage);
    messageInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Lógica para el admin: seleccionar un chat
    if (currentUser.is_superuser) {
        document.querySelectorAll('.user-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                activeChatRecipientId = this.dataset.driverId;
                chatHeader.textContent = `Chat con ${this.dataset.driverName}`;
                inputContainer.style.display = 'flex';
                chatLog.innerHTML = ''; // Limpiar chat anterior
                if (noChatSelected) noChatSelected.style.display = 'none';
            });
        });
    }

    // Lógica para el conductor: iniciar chat con el admin
    if (!currentUser.is_superuser) {
        activeChatRecipientId = adminUserId;
        chatHeader.textContent = 'Chat con la Central';
        inputContainer.style.display = 'flex';
        if (noChatSelected) noChatSelected.style.display = 'none';
    }

    // ==================== FUNCIONALIDAD DE AUDIO ====================
    let mediaRecorder;
    let audioChunks = [];
    const recordBtn = document.getElementById('record-audio-btn');
    const stopBtn = document.getElementById('stop-audio-btn');
    const audioPlayer = document.getElementById('audio-player');

    // Botón para iniciar grabación
    recordBtn.addEventListener('click', async function() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                sendAudioMessage(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            recordBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            console.log('🎤 Grabando audio...');
        } catch (error) {
            console.error('Error al acceder al micrófono:', error);
            alert('No se pudo acceder al micrófono. Verifica los permisos.');
        }
    });

    // Botón para detener grabación
    stopBtn.addEventListener('click', function() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            stopBtn.style.display = 'none';
            recordBtn.style.display = 'inline-block';
            console.log('⏹️ Grabación detenida');
        }
    });

    // Enviar audio por WebSocket
    function sendAudioMessage(audioBlob) {
        const reader = new FileReader();
        reader.onloadend = function() {
            const base64Audio = reader.result.split(',')[1];
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN && activeChatRecipientId) {
                chatSocket.send(JSON.stringify({
                    'audio': base64Audio,
                    'recipient_id': activeChatRecipientId
                }));
                console.log('🔊 Audio enviado');
                appendAudioMessage('Tú', true);
            } else {
                console.error('WebSocket no está conectado o no hay destinatario seleccionado');
            }
        };
        reader.readAsDataURL(audioBlob);
    }

    // Agregar mensaje de audio al chat
    function appendAudioMessage(senderName, isSent) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(isSent ? 'sent' : 'received');

        messageDiv.innerHTML = `
            <div>
                <div class="message-sender">${senderName}</div>
                <div class="message-bubble">🔊 Mensaje de audio</div>
            </div>
        `;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Modificar onmessage para manejar audio
    const originalOnMessage = chatSocket ? chatSocket.onmessage : null;
    
    function setupWebSocketWithAudio() {
        setupWebSocket();
        
        // Esperar a que chatSocket esté definido
        setTimeout(() => {
            if (chatSocket) {
                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    
                    // Manejar mensajes de audio
                    if (data.audio && (data.sender_id == activeChatRecipientId || data.sender_id == currentUser.id)) {
                        const audioData = 'data:audio/webm;base64,' + data.audio;
                        audioPlayer.src = audioData;
                        audioPlayer.play();
                        appendAudioMessage(data.sender_name || 'Conductor', data.sender_id != currentUser.id);
                        console.log('🔊 Audio recibido y reproduciendo');
                    }
                    // Manejar mensajes de texto
                    else if (data.message && (data.sender_id == activeChatRecipientId || data.sender_id == currentUser.id)) {
                        appendMessage(data.message, data.sender_id, data.sender_name);
                    }
                };
            }
        }, 100);
    }

    // Iniciar la conexión con soporte de audio
    setupWebSocketWithAudio();
});
</script>
{% endblock %}
