{% extends 'base.html' %}
{% load static %}

{% block title %}Central de Comunicaci√≥n{% endblock %}

{% block extra_head %}
<script>
    // Agregar clase al body para ocultar bot√≥n flotante en esta vista
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('central-comunicacion-page');
    });
</script>
{% endblock %}

{% block content %}
<style>
    /* === ANIMACIONES PARA SISTEMA DE AUDIO === */
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes audioIndicatorPulse {

        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.05);
            opacity: 0.9;
        }
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* === DISE√ëO PROFESIONAL CENTRO DE COMANDO === */
    body {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Sobrescribir estilos del contenedor principal de base.html */
    .container,
    .container-fluid {
        background: transparent !important;
        padding: 0 !important;
        max-width: 100% !important;
    }

    .command-center-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #fff;
        padding: 20px 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid #0f3460;
    }

    .command-center-header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .command-center-header h1::before {
        content: "üöï";
        font-size: 2rem;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 20px;
        border-radius: 25px;
        backdrop-filter: blur(10px);
    }

    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4CAF50;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }

    .main-layout {
        display: flex;
        height: calc(100vh - 80px);
        gap: 0;
        flex-direction: row;
        position: relative;
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 1024px) {
        .main-layout {
            flex-direction: column;
            height: auto;
            min-height: calc(100vh - 80px);
        }
    }

    @media (max-width: 768px) {
        .command-center-header h1 {
            font-size: 1.2rem;
        }

        .status-indicator span {
            display: none;
        }
    }

    .map-container {
        width: 400px;
        height: 100%;
        border-right: 3px solid #0f3460;
        position: relative;
        flex-shrink: 0;
    }

    @media (max-width: 1024px) {
        .map-container {
            width: 100%;
            height: 300px;
            border-right: none;
            border-bottom: 3px solid #0f3460;
        }
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .content-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
        height: 100%;
        position: relative;
    }

    @media (max-width: 1024px) {
        .content-layout {
            flex-direction: column;
            height: auto;
        }
    }

    /* ESTADOS DE VISIBILIDAD */
    .chat-window.hidden {
        display: none;
    }

    .audio-log-panel.hidden {
        display: none;
    }

    /* BOTONES FLOTANTES PARA MOSTRAR PANELES OCULTOS */
    .floating-controls {
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1000;
    }

    .floating-btn {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        font-size: 18px;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        opacity: 0;
        transform: scale(0) translateY(-50%);
        pointer-events: none;
    }

    .floating-btn.visible {
        opacity: 1;
        transform: scale(1) translateY(0);
        pointer-events: all;
    }

    .floating-btn:hover {
        transform: scale(1.1) translateY(-2px);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
    }

    .floating-btn.chat-btn {
        background: linear-gradient(135deg, #6c5ce7 0%, #5f3dc4 100%);
        box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
    }

    .floating-btn.chat-btn:hover {
        box-shadow: 0 6px 20px rgba(108, 92, 231, 0.6);
    }

    .floating-btn.audio-btn {
        background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
        box-shadow: 0 4px 15px rgba(225, 112, 85, 0.4);
    }

    .floating-btn.audio-btn:hover {
        box-shadow: 0 6px 20px rgba(225, 112, 85, 0.6);
    }

    /* RESPONSIVE ADJUSTMENTS PARA M√ìVILES */
    @media (max-width: 768px) {
        .header-controls {
            gap: 5px;
        }

        .header-toggle-btn {
            padding: 3px 6px;
            font-size: 10px;
            min-width: 18px;
            height: 20px;
        }

        .chat-header,
        .audio-log-header {
            padding: 12px 15px;
        }

        .audio-log-header {
            font-size: 0.8rem;
        }

        /* Ajustar botones flotantes en m√≥vil */
        .floating-controls {
            right: 10px;
            bottom: 20px;
            top: auto;
            transform: none;
            flex-direction: row;
            justify-content: center;
            gap: 15px;
        }

        .floating-btn {
            width: 45px;
            height: 45px;
            font-size: 16px;
        }
    }

    .chat-container {
        display: flex;
        flex: 1;
        background: #fff;
        border-radius: 0;
        box-shadow: none;
        overflow: hidden;
        margin: 0;
        min-height: 400px;
    }

    @media (max-width: 1024px) {
        .chat-container {
            min-height: 300px;
            flex-direction: column;
        }
    }

    .chat-window {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 0;
    }

    .chat-header {
        padding: 15px 20px;
        background: linear-gradient(135deg, #6c5ce7 0%, #5f3dc4 100%);
        color: white;
        font-weight: 600;
        font-size: 1rem;
        border-bottom: 2px solid #5f3dc4;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .header-toggle-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 15px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 3px;
        backdrop-filter: blur(10px);
        min-width: 20px;
        height: 24px;
    }

    .header-toggle-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }

    .header-toggle-btn.minimize {
        background: rgba(231, 76, 60, 0.8);
    }

    .header-toggle-btn.minimize:hover {
        background: rgba(231, 76, 60, 1);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #fff;
        min-height: 300px;
        position: relative;
        z-index: 1;
    }
    
    /* Asegurar que los mensajes sean visibles */
    .chat-messages .message {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative;
        z-index: 2;
    }

    @media (max-width: 768px) {
        .chat-messages {
            min-height: 200px;
            padding: 15px;
        }
    }

    .chat-input-area {
        padding: 15px 20px;
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        border-top: 2px solid #0984e3;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    @media (max-width: 768px) {
        .chat-input-area {
            padding: 10px 15px;
            flex-wrap: wrap;
        }
    }

    #chat-message-input {
        flex: 1;
        padding: 10px 15px;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.95);
        font-size: 14px;
        outline: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    #chat-message-input:focus {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        background: white;
    }

    @media (max-width: 768px) {
        #chat-message-input {
            width: 100%;
            margin-bottom: 10px;
        }
    }

    #chat-message-submit {
        background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        box-shadow: 0 3px 10px rgba(0, 184, 148, 0.3);
    }

    #chat-message-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 184, 148, 0.5);
    }

    @media (max-width: 768px) {
        #chat-message-submit {
            width: 100%;
        }
    }

    #chat-file-btn {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        box-shadow: 0 3px 10px rgba(108, 117, 125, 0.3);
        font-size: 16px;
        position: relative;
        z-index: 10;
        pointer-events: auto !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    #chat-file-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 117, 125, 0.5);
        background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
    }

    #chat-file-btn:active {
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        #chat-file-btn {
            width: auto;
            flex-shrink: 0;
        }
    }
    
    /* Asegurar que el input de archivo est√© accesible */
    #chat-file-input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
    }

    .audio-log-panel {
        width: 320px;
        background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
        border-left: 2px solid #2d3748;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    @media (max-width: 1024px) {
        .audio-log-panel {
            width: 100%;
            height: 250px;
            border-left: none;
            border-top: 2px solid #2d3748;
        }
    }

    .audio-log-header {
        padding: 20px;
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        color: #fff;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.9rem;
        border-bottom: 2px solid #2d3748;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .audio-log-header .header-controls {
        display: flex;
        gap: 5px;
    }

    .audio-log-header .header-toggle-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .audio-log-header .header-toggle-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    @media (max-width: 768px) {
        .audio-log-header {
            padding: 15px;
            font-size: 0.8rem;
        }
    }

    .audio-log-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    @media (max-width: 768px) {
        .audio-log-content {
            padding: 10px;
        }
    }

    .audio-log-item {
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid #4CAF50;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        animation: slideInRight 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 768px) {
        .audio-log-item {
            padding: 10px;
            margin-bottom: 8px;
        }
    }

    .audio-log-item.sent {
        border-left-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
    }

    .audio-log-item.received {
        border-left-color: #4CAF50;
        background: rgba(76, 175, 80, 0.1);
    }

    .audio-log-sender {
        color: #fff;
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .audio-log-sender::before {
        content: "üé§";
        font-size: 1rem;
    }

    .audio-log-time {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.75rem;
    }

    .audio-log-empty {
        color: rgba(255, 255, 255, 0.3);
        text-align: center;
        padding: 40px 20px;
        font-size: 0.9rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 10px;
        border: 1px dashed rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 768px) {
        .audio-log-empty {
            padding: 20px 15px;
            font-size: 0.8rem;
        }
    }

    /* ESTILOS PARA EL PANEL DE COMUNICACI√ìN CENTRAL MEJORADO */
    .central-broadcast-panel {
        width: 380px;
        background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
        border-right: 3px solid #1a252f;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    @media (max-width: 1024px) {
        .central-broadcast-panel {
            width: 100%;
            height: auto;
            min-height: 250px;
            border-right: none;
            border-bottom: 3px solid #1a252f;
        }
    }

    .broadcast-header {
        padding: 15px 20px;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: #fff;
        font-weight: 700;
        letter-spacing: 0.5px;
        font-size: 1rem;
        border-bottom: 2px solid #a93226;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .broadcast-controls {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        gap: 15px;
        background: linear-gradient(180deg, #34495e 0%, #2c3e50 100%);
    }

    .central-mic-section {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #record-audio-btn {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 100px;
        height: 100px;
        cursor: pointer;
        user-select: none;
        font-size: 40px;
        box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        position: relative;
        overflow: hidden;
    }

    #record-audio-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    #record-audio-btn:hover::before {
        left: 100%;
    }

    #record-audio-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 35px rgba(231, 76, 60, 0.6);
    }

    #record-audio-btn:active {
        transform: scale(0.95);
    }

    .mic-label {
        color: #ecf0f1;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 5px;
    }

    .mic-sublabel {
        color: #bdc3c7;
        font-size: 12px;
        line-height: 1.4;
    }

    /* SECCI√ìN DE CONTROLES AVANZADOS */
    .advanced-controls {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .control-group {
        margin-bottom: 15px;
    }

    .control-group:last-child {
        margin-bottom: 0;
    }

    .control-label {
        color: #ecf0f1;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
    }

    .button-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .control-btn {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 80px;
        box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
    }

    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.5);
    }

    .control-btn.emergency {
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        box-shadow: 0 3px 10px rgba(230, 126, 34, 0.3);
    }

    .control-btn.emergency:hover {
        box-shadow: 0 5px 15px rgba(230, 126, 34, 0.5);
    }

    .status-indicator-panel {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .status-row:last-child {
        margin-bottom: 0;
    }

    .status-text {
        color: #bdc3c7;
        font-size: 12px;
    }

    .status-value {
        color: #27ae60;
        font-size: 12px;
        font-weight: 600;
    }

    /* RESPONSIVE ADJUSTMENTS */
    @media (max-width: 768px) {
        #record-audio-btn {
            width: 80px;
            height: 80px;
            font-size: 32px;
        }

        .broadcast-controls {
            padding: 15px;
            gap: 10px;
        }

        .button-row {
            flex-direction: column;
        }

        .control-btn {
            flex: none;
            width: 100%;
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* ANIMACIONES ADICIONALES */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .central-mic-section {
        animation: fadeInUp 0.5s ease;
    }

    .advanced-controls {
        animation: fadeInUp 0.7s ease;
    }

    .status-indicator-panel {
        animation: fadeInUp 0.9s ease;
    }

    .user-list {
        width: 30%;
        max-width: 350px;
        border-right: 2px solid #0f3460;
        overflow-y: auto;
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
    }

    .user-list-header {
        padding: 20px;
        font-size: 1.1rem;
        font-weight: 700;
        border-bottom: 2px solid #0f3460;
        background: rgba(15, 52, 96, 0.5);
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .chat-header {
        padding: 20px;
        font-size: 1.2rem;
        font-weight: 600;
        border-bottom: 2px solid #e0e0e0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        color: #fff;
        position: relative;
    }

    .user-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: #4CAF50;
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }

    .user-item:hover {
        background-color: rgba(102, 126, 234, 0.2);
        transform: translateX(5px);
    }

    .user-item:hover::before,
    .user-item.active::before {
        transform: scaleY(1);
    }

    .user-item.active {
        background-color: rgba(102, 126, 234, 0.3);
        border-left: 3px solid #4CAF50;
    }

    .user-item img {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 15px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .chat-window {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        flex-shrink: 0;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: linear-gradient(180deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    .message {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease;
        position: relative;
        z-index: 2;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.sent {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        text-align: right;
        border-bottom-right-radius: 4px;
    }

    .message.received {
        background: #fff;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 4px;
        border-left: 3px solid #667eea;
    }

    .message-sender {
        font-size: 0.8rem;
        color: #888;
        margin: 0 5px 5px 5px;
    }

    .chat-input-area {
        display: flex;
        padding: 15px;
        border-top: 2px solid #e0e0e0;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        gap: 10px;
        align-items: center;
    }

    #chat-message-input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        outline: none;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
    }

    #chat-message-input:focus {
        border-color: #667eea;
        background: #fff;
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
    }

    #chat-message-submit {
        padding: 12px 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    #chat-message-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    #no-chat-selected {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #667eea;
        font-size: 1.2rem;
        font-weight: 600;
        flex-direction: column;
        gap: 15px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 0;
        pointer-events: none;
    }
    
    /* Cuando hay mensajes, ocultar completamente #no-chat-selected */
    .chat-messages:has(.message) #no-chat-selected,
    #chat-log:has(.message) #no-chat-selected {
        display: none !important;
    }

    #no-chat-selected::before {
        content: "üí¨";
        font-size: 4rem;
        opacity: 0.5;
    }

    /* === GOOGLE MAPS INFOWINDOW TEXT VISIBILITY FIX === */
    /* Force dark text in InfoWindows to override theme.css white text */
    .gm-style-iw-c,
    .gm-style-iw-d,
    .gm-style .gm-style-iw-c,
    .gm-style .gm-style-iw-d {
        color: #333 !important;
    }

    .gm-style-iw-c div,
    .gm-style-iw-d div,
    .gm-style-iw-c p,
    .gm-style-iw-d p,
    .gm-style-iw-c h5,
    .gm-style-iw-d h5,
    .gm-style-iw-c strong,
    .gm-style-iw-d strong,
    .gm-style-iw-c span,
    .gm-style-iw-d span {
        color: #333 !important;
    }
</style>

<!-- HEADER DEL CENTRO DE COMANDO -->
<div class="command-center-header">
    <h1>Central de Control - De Aqu√≠ Pa'll√°</h1>
    <div class="status-indicator">
        <div class="status-dot"></div>
        <span>Sistema Activo</span>
    </div>
</div>

<div class="main-layout">
    <!-- MAPA DE UBICACIONES EN TIEMPO REAL -->
    <div class="map-container">
        <div id="map"></div>
        <!-- Bot√≥n flotante para controlar tr√°fico -->
        <button id="traffic-toggle" onclick="toggleTraffic()" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: 2px solid #4CAF50; border-radius: 8px; padding: 10px 15px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-weight: bold; color: #4CAF50;">
            üö¶ Tr√°fico: ON
        </button>
    </div>

    <div class="content-layout">
        <div class="chat-container">
            {% if request.user.is_superuser %}
            <div class="user-list">
                <div class="user-list-header">Conductores</div>
                {% if drivers_with_history %}
                    {% for item in drivers_with_history %}
                    {% with driver=item.driver chat_history=item.chat_history %}
                    <div class="user-item" 
                         data-driver-id="{{ driver.id }}" 
                         data-driver-name="{{ driver.get_full_name }}" 
                         data-chat-history-loaded="true"
                         data-initial-history='{% if chat_history %}[{% for msg in chat_history %}{"sender_id": {{ msg.sender.id }}, "sender_name": "{{ msg.sender.get_full_name|default:msg.sender.username|escapejs }}", "message": "{{ msg.message|escapejs }}", "timestamp": "{{ msg.timestamp|date:"c" }}", "is_sent": {% if msg.sender == request.user %}true{% else %}false{% endif %}}{% if not forloop.last %},{% endif %}{% endfor %}]{% else %}[]{% endif %}'>
                        {# En producci√≥n (Railway) normalmente no se sirve /media/. Evitar /media/default.jpg #}
                        <img src="{% if driver.profile_picture and driver.profile_picture.name and driver.profile_picture.name != 'default.jpg' %}{{ driver.profile_picture.url }}{% else %}{% static 'imagenes/logo1.png' %}{% endif %}"
                            onerror="this.onerror=null;this.src='{% static 'imagenes/logo1.png' %}';"
                            alt="{{ driver.get_full_name }}">
                        <span>{{ driver.get_full_name }}</span>
                        {% if item.last_message %}
                        <small style="display: block; font-size: 0.8em; color: #666; margin-top: 4px;">
                            {{ item.last_message.message|truncatewords:10 }}
                        </small>
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% endfor %}
                {% else %}
                    {% for driver in drivers %}
                    <div class="user-item" data-driver-id="{{ driver.id }}" data-driver-name="{{ driver.get_full_name }}">
                        {# En producci√≥n (Railway) normalmente no se sirve /media/. Evitar /media/default.jpg #}
                        <img src="{% if driver.profile_picture and driver.profile_picture.name and driver.profile_picture.name != 'default.jpg' %}{{ driver.profile_picture.url }}{% else %}{% static 'imagenes/logo1.png' %}{% endif %}"
                            onerror="this.onerror=null;this.src='{% static 'imagenes/logo1.png' %}';"
                            alt="{{ driver.get_full_name }}">
                        <span>{{ driver.get_full_name }}</span>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            {% endif %}

            <!-- PANEL DE COMUNICACI√ìN CENTRAL MEJORADO -->
            <div class="central-broadcast-panel">
                <div class="broadcast-header">
                    üì¢ COMUNICACI√ìN CENTRAL
                </div>
                <div class="broadcast-controls">
                    <!-- SECCI√ìN DE MICR√ìFONO PRINCIPAL -->
                    <div class="central-mic-section">
                        <button id="record-audio-btn">üé§</button>
                        <div class="mic-label">TRANSMISI√ìN GENERAL</div>
                        <div class="mic-sublabel">Mant√©n presionado para hablar<br>con TODOS los conductores</div>
                    </div>

                    <!-- CONTROLES AVANZADOS -->
                    <div class="advanced-controls">
                        <div class="control-group">
                            <label class="control-label">üì° Acciones R√°pidas</label>
                            <div class="button-row">
                                <button class="control-btn" onclick="testConnection()">üîó Test</button>
                                <button class="control-btn emergency" onclick="emergencyBroadcast()">üö®
                                    Emergencia</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">üéõÔ∏è Configuraci√≥n</label>
                            <div class="button-row">
                                <button class="control-btn" onclick="toggleMute()">üîá Silenciar</button>
                                <button class="control-btn" onclick="clearHistory()">üóëÔ∏è Limpiar</button>
                            </div>
                        </div>
                    </div>

                    <!-- INDICADORES DE ESTADO -->
                    <div class="status-indicator-panel">
                        <div class="status-row">
                            <span class="status-text">üåê Conexi√≥n:</span>
                            <span class="status-value" id="connection-status">Conectado</span>
                        </div>
                        <div class="status-row">
                            <span class="status-text">üë• Conductores:</span>
                            <span class="status-value" id="drivers-count">{{ drivers|length }}</span>
                        </div>
                        <div class="status-row">
                            <span class="status-text">üìä Estado:</span>
                            <span class="status-value" id="system-status">Operativo</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PANEL DE CHAT PRIVADO MEJORADO -->
            <div class="chat-window">
                <div class="chat-header" id="chat-header">
                    <span>üí¨ Chat Privado</span>
                    <div class="header-controls">
                        <button class="header-toggle-btn" id="toggle-fullscreen" onclick="toggleFullscreen()"
                            title="Pantalla completa (F11)">üî≥</button>
                        <button class="header-toggle-btn minimize" onclick="toggleChat()"
                            title="Ocultar chat (Ctrl+H)">‚úï</button>
                    </div>
                </div>
                <div class="chat-messages" id="chat-log">
                    <div id="no-chat-selected">
                        <div style="text-align: center; padding: 40px 20px; color: #7f8c8d;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üí¨</div>
                            <h3 style="color: #34495e; margin-bottom: 10px;">Chat Privado</h3>
                            <p>Selecciona un conductor de la lista para iniciar una conversaci√≥n privada</p>
                        </div>
                    </div>
                </div>
                <div class="chat-input-area" id="chat-input-container" style="display: none;">
                    <input type="file" id="chat-file-input" accept="image/*,video/*" style="display: none;">
                    <button id="chat-file-btn" title="Adjuntar imagen o video" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-right: 5px;">üìé</button>
                    <input id="chat-message-input" type="text" placeholder="Escribe un mensaje privado...">
                    <button id="chat-message-submit">üì§ Enviar</button>
                </div>
            </div>
        </div>

        <!-- PANEL DE REGISTRO DE AUDIO -->
        <div class="audio-log-panel">
            <div class="audio-log-header">
                <span>üìª Registro de Audio</span>
                <div class="header-controls">
                    <button class="header-toggle-btn" onclick="clearHistory()" title="Limpiar historial">üóëÔ∏è</button>
                    <button class="header-toggle-btn minimize" onclick="toggleAudioLog()"
                        title="Ocultar audio (Ctrl+J)">‚úï</button>
                </div>
            </div>
            <div class="audio-log-content" id="audio-log">
                <div class="audio-log-empty">
                    No hay comunicaciones de audio a√∫n
                </div>
            </div>
        </div>
    </div> <!-- Cierre content-layout -->
</div> <!-- Cierre main-layout -->

<!-- REPRODUCTOR DE AUDIO OCULTO -->
<audio id="audio-player" style="display: none;"></audio>

<!-- BOTONES FLOTANTES PARA PANELES OCULTOS -->
<div class="floating-controls">
    <button class="floating-btn chat-btn" id="floating-chat-btn" onclick="toggleChat()"
        title="Mostrar Chat (Ctrl+H)">üí¨</button>
    <button class="floating-btn audio-btn" id="floating-audio-btn" onclick="toggleAudioLog()"
        title="Mostrar Audio (Ctrl+J)">üìª</button>
</div>

<audio id="audio-player" style="display: none;"></audio>

{% endblock %}

{% block extra_scripts %}
<!-- 
‚úÖ IMPORTANTE: Todo el c√≥digo JavaScript est√° en comunicacion-completa.js
‚ùå NO usar script inline para evitar conflictos de WebSocket y reconexiones infinitas
√öltima actualizaci√≥n: 2025-12-17 18:42
-->
<!--
<script>
    // Variables globales para el mapa (renombradas para evitar conflictos)
    let centralMap;
    let centralMarkers = {};

    document.addEventListener('DOMContentLoaded', function () {
        const currentUser = {
            id: {{ request.user.id }},  // Cambiar a n√∫mero para comparaciones correctas
            is_superuser: {{ request.user.is_superuser|yesno:"true,false" }}
        };
        const adminUserId = "{{ admin_user_id }}";

    const chatLog = document.getElementById('chat-log');
    const chatHeader = document.getElementById('chat-header');
    const messageInput = document.getElementById('chat-message-input');
    const messageSubmit = document.getElementById('chat-message-submit');
    const inputContainer = document.getElementById('chat-input-container');
    const noChatSelected = document.getElementById('no-chat-selected');
    const audioLogPanel = document.getElementById('audio-log');

    let activeChatRecipientId = null;
    let chatSocket = null;

    // Funci√≥n para agregar entrada al registro de audio
    function addAudioLogEntry(senderName, type) {
        const emptyMsg = audioLogPanel.querySelector('.audio-log-empty');
        if (emptyMsg) emptyMsg.remove();

        const logItem = document.createElement('div');
        logItem.className = `audio-log-item ${type}`;

        const now = new Date();
        const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        logItem.innerHTML = `
            <div class="audio-log-sender">${senderName}</div>
            <div class="audio-log-time">${timeStr}</div>
        `;

        audioLogPanel.insertBefore(logItem, audioLogPanel.firstChild);

        // Mantener solo los √∫ltimos 20 registros
        const items = audioLogPanel.querySelectorAll('.audio-log-item');
        if (items.length > 20) {
            items[items.length - 1].remove();
        }
    }

    function setupWebSocket() {
        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const wsPath = wsProtocol + window.location.host + '/ws/chat/';

        chatSocket = new WebSocket(wsPath);

        chatSocket.onopen = function (e) {
            console.log('Chat WebSocket conectado.');
        };

        chatSocket.onclose = function (e) {
            console.error('Chat WebSocket desconectado. Reintentando en 5s...');
            setTimeout(setupWebSocket, 5000);
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            const { message, sender_id, sender_name } = data;

            // Solo mostrar mensajes recibidos (mis mensajes ya se agregaron al enviar)
            if (sender_id == activeChatRecipientId) {
                appendMessage(message, sender_id, sender_name);
            }
        };
    }

    function appendMessage(message, sender_id, sender_name, isSentOverride = null) {
        if (noChatSelected) noChatSelected.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        // Usar isSentOverride si se proporciona, de lo contrario comparar sender_id con currentUser.id
        const isSent = isSentOverride !== null ? isSentOverride : (String(sender_id) === String(currentUser.id));
        messageDiv.classList.add(isSent ? 'sent' : 'received');

        messageDiv.innerHTML = `
            <div>
                <div class="message-sender">${isSent ? 'T√∫' : sender_name}</div>
                <div class="message-bubble">${message}</div>
            </div>
        `;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && activeChatRecipientId && chatSocket.readyState === WebSocket.OPEN) {
            // Agregar el mensaje inmediatamente a la vista
            appendMessage(message, currentUser.id, 'T√∫');

            // Enviar por WebSocket
            chatSocket.send(JSON.stringify({
                'message': message,
                'recipient_id': activeChatRecipientId
            }));
            messageInput.value = '';
        }
    }

    messageSubmit.addEventListener('click', sendMessage);
    messageInput.addEventListener('keyup', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // L√≥gica para el admin: seleccionar un chat
    if (currentUser.is_superuser) {
        document.querySelectorAll('.user-item').forEach(item => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                activeChatRecipientId = this.dataset.driverId;
                chatHeader.textContent = `Chat con: ${this.dataset.driverName}`;
                inputContainer.style.display = 'flex';
                if (noChatSelected) noChatSelected.style.display = 'none';

                // Verificar si hay historial precargado en el HTML
                const initialHistory = document.getElementById('initial-chat-history');
                const hasPreloadedHistory = this.dataset.chatHistoryLoaded === 'true';
                
                if (hasPreloadedHistory && initialHistory && initialHistory.dataset.driverId === activeChatRecipientId) {
                    // Usar el historial precargado del HTML
                    console.log(`üìú Usando historial precargado para conductor ${activeChatRecipientId}`);
                    chatLog.innerHTML = ''; // Limpiar chat anterior
                    
                    // Parsear el historial del data attribute
                    try {
                        const historyData = JSON.parse(this.dataset.initialHistory || '[]');
                        if (historyData.length > 0) {
                            historyData.forEach((msg, index) => {
                                appendMessage(msg.message, msg.sender_id, msg.sender_name, msg.is_sent);
                            });
                            console.log(`‚úÖ Historial precargado mostrado: ${historyData.length} mensajes`);
                        } else {
                            chatLog.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">No hay mensajes anteriores</div>';
                        }
                    } catch (e) {
                        console.error('‚ùå Error parseando historial precargado:', e);
                        // Si falla, cargar desde API
                        loadChatHistoryFromAPI();
                    }
                } else {
                    // Cargar desde API
                    loadChatHistoryFromAPI();
                }
                
                function loadChatHistoryFromAPI() {
                    chatLog.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Cargando historial...</div>';
                    
                    console.log(`üìú Cargando historial desde API para usuario ${activeChatRecipientId}`);
                    fetch(`/api/chat_history/${activeChatRecipientId}/`)
                        .then(response => {
                            console.log(`üì° Respuesta recibida:`, response.status);
                            if (!response.ok) {
                                console.error(`‚ùå Error HTTP: ${response.status}`);
                                return response.text().then(text => {
                                    console.error(`‚ùå Respuesta del servidor:`, text);
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(`üì® Datos del historial:`, data);
                            chatLog.innerHTML = ''; // Limpiar indicador de carga
                            
                            if (data.messages && data.messages.length > 0) {
                                console.log(`‚úÖ Cargando ${data.messages.length} mensajes`);
                                data.messages.forEach((msg, index) => {
                                    const isSent = msg.is_sent !== undefined ? msg.is_sent : (Number(msg.sender_id) === Number(currentUser.id));
                                    appendMessage(msg.message, msg.sender_id, msg.sender_name, isSent);
                                });
                                console.log(`‚úÖ Historial cargado correctamente`);
                            } else {
                                console.log('‚ÑπÔ∏è No hay mensajes en el historial');
                                chatLog.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">No hay mensajes anteriores</div>';
                            }
                        })
                        .catch(error => {
                            console.error('‚ùå Error cargando historial:', error);
                            console.error('‚ùå Stack trace:', error.stack);
                            chatLog.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error cargando historial. Intenta de nuevo.</div>';
                        });
                }
            });
        });
        
        // Auto-seleccionar el primer conductor al cargar la p√°gina
        const firstDriver = document.querySelector('.user-item');
        if (firstDriver) {
            console.log('üéØ Auto-seleccionando primer conductor al cargar');
            firstDriver.click();
        }
    }

    // L√≥gica para el conductor: iniciar chat con el admin
    if (!currentUser.is_superuser) {
        activeChatRecipientId = adminUserId;
        chatHeader.textContent = 'Chat con la Central';
        inputContainer.style.display = 'flex';
        if (noChatSelected) noChatSelected.style.display = 'none';
    }

    // ==================== FUNCIONALIDAD DE AUDIO ====================
    let mediaRecorder;
    let audioChunks = [];
    let audioSocket = null;
    const recordBtn = document.getElementById('record-audio-btn');
    const audioPlayer = document.getElementById('audio-player');

    // Configurar WebSocket de audio (AHORA MANEJADO GLOBALMENTE EN BASE.HTML)
    /*
    function setupAudioWebSocket() {
        // ... l√≥gica movida a base.html ...
    }
    */

    // WALKIE-TALKIE: Mantener presionado para hablar
    let audioStream = null;

    // Inicializar micr√≥fono al cargar
    async function initMicrophone() {
        try {
            audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(audioStream);

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                sendAudioMessage(audioBlob);
                audioChunks = [];
            };

            console.log('üé§ Micr√≥fono listo');
        } catch (error) {
            console.error('Error al acceder al micr√≥fono:', error);
            alert('No se pudo acceder al micr√≥fono. Verifica los permisos.');
        }
    }

    // Mousedown: Empezar a grabar COMUNICACI√ìN CENTRAL
    recordBtn.addEventListener('mousedown', function () {
        if (mediaRecorder && mediaRecorder.state === 'inactive') {
            audioChunks = [];
            mediaRecorder.start();
            recordBtn.style.background = 'linear-gradient(135deg, #cc4b43 0%, #aa3b33 100%)';
            recordBtn.style.transform = 'scale(0.95)';
            console.log('üéôÔ∏è Grabando COMUNICACI√ìN CENTRAL... (suelta para enviar a TODOS)');
        }
    });

    // Mouseup: Detener y enviar COMUNICACI√ìN CENTRAL
    recordBtn.addEventListener('mouseup', function () {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            recordBtn.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #ee5a52 100%)';
            recordBtn.style.transform = 'scale(1)';
            console.log('üì§ Enviando audio central a TODOS los conductores...');
        }
    });

    // Mouseleave: Si sale del bot√≥n mientras graba, detener
    recordBtn.addEventListener('mouseleave', function () {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            recordBtn.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #ee5a52 100%)';
            recordBtn.style.transform = 'scale(1)';
            console.log('üì§ Enviando audio central a TODOS los conductores...');
        }
    });

    // Touch para m√≥viles - COMUNICACI√ìN CENTRAL
    recordBtn.addEventListener('touchstart', function (e) {
        e.preventDefault();
        if (mediaRecorder && mediaRecorder.state === 'inactive') {
            audioChunks = [];
            mediaRecorder.start();
            recordBtn.style.background = 'linear-gradient(135deg, #cc4b43 0%, #aa3b33 100%)';
            recordBtn.style.transform = 'scale(0.95)';
            console.log('üéôÔ∏è Grabando COMUNICACI√ìN CENTRAL (touch)... (suelta para enviar a TODOS)');
        }
    });

    recordBtn.addEventListener('touchend', function (e) {
        e.preventDefault();
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            recordBtn.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #ee5a52 100%)';
            recordBtn.style.transform = 'scale(1)';
            console.log('üì§ Enviando audio central (touch) a TODOS los conductores...');
        }
    });

    // Inicializar micr√≥fono
    initMicrophone();

    // Enviar audio por WebSocket
    function sendAudioMessage(audioBlob) {
        const reader = new FileReader();
        reader.onloadend = function () {
            const base64Audio = reader.result.split(',')[1];
            if (audioSocket && audioSocket.readyState === WebSocket.OPEN) {
                audioSocket.send(JSON.stringify({
                    'type': 'central_audio_message',
                    'audio': base64Audio,
                    'senderId': currentUser.id,  // ID del usuario admin
                    'senderRole': 'Central'
                }));
                console.log('üì§ Audio enviado a conductores con ID:', currentUser.id);
                appendAudioMessage('T√∫ (Central)', true);

                // Agregar al registro de audio
                addAudioLogEntry('üì§ T√∫ (Central)', 'sent');
            } else {
                console.error('Audio WebSocket no est√° conectado');
                alert('No se puede enviar audio. WebSocket desconectado.');
            }
        };
        reader.readAsDataURL(audioBlob);
    }

    // Agregar mensaje de audio al registro (NO al chat)
    function appendAudioMessage(senderName, isSent) {
        // NO agregar al chat, solo al registro de audio
        console.log(`üé§ Audio ${isSent ? 'enviado' : 'recibido'}: ${senderName}`);
    }

    // FUNCIONES PARA LOS CONTROLES AVANZADOS
    window.testConnection = function () {
        console.log('üîó Probando conexi√≥n...');
        const statusEl = document.getElementById('connection-status');
        statusEl.textContent = 'Probando...';
        statusEl.style.color = '#f39c12';

        // Simular test de conexi√≥n
        setTimeout(() => {
            if (audioSocket && audioSocket.readyState === WebSocket.OPEN) {
                statusEl.textContent = 'Conectado';
                statusEl.style.color = '#27ae60';
                showNotification('‚úÖ Conexi√≥n exitosa', 'success');
            } else {
                statusEl.textContent = 'Desconectado';
                statusEl.style.color = '#e74c3c';
                showNotification('‚ùå Error de conexi√≥n', 'error');
            }
        }, 1000);
    }

    window.emergencyBroadcast = function () {
        console.log('üö® Transmisi√≥n de emergencia');
        showNotification('üö® Modo emergencia activado', 'warning');

        // Cambiar el estilo del bot√≥n de micr√≥fono temporalmente
        const micBtn = document.getElementById('record-audio-btn');
        const originalStyle = micBtn.style.background;
        micBtn.style.background = 'linear-gradient(135deg, #e67e22 0%, #d35400 100%)';

        setTimeout(() => {
            micBtn.style.background = originalStyle;
        }, 3000);
    }

    let isMuted = false;
    window.toggleMute = function () {
        isMuted = !isMuted;
        const btn = event.target;
        if (isMuted) {
            btn.textContent = 'üîä Activar';
            btn.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
            showNotification('üîá Micr√≥fono silenciado', 'info');
        } else {
            btn.textContent = 'üîá Silenciar';
            btn.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
            showNotification('üîä Micr√≥fono activado', 'success');
        }
    }

    window.clearHistory = function () {
        console.log('üóëÔ∏è Limpiando historial...');
        const audioLog = document.getElementById('audio-log');
        if (audioLog) {
            audioLog.innerHTML = '<div class="audio-log-empty">No hay comunicaciones de audio a√∫n</div>';
        }
        showNotification('üóëÔ∏è Historial limpiado', 'info');
    }

    // FUNCIONES PARA CONTROLAR VISIBILIDAD DE PANELES
    window.toggleChat = function () {
        const chatWindow = document.querySelector('.chat-window');
        const floatingBtn = document.getElementById('floating-chat-btn');

        if (chatWindow.classList.contains('hidden')) {
            chatWindow.classList.remove('hidden');
            floatingBtn.classList.remove('visible');
            showNotification('üí¨ Chat activado', 'success');
        } else {
            chatWindow.classList.add('hidden');
            floatingBtn.classList.add('visible');
            showNotification('üí¨ Chat oculto', 'info');
        }
    }

    window.toggleAudioLog = function () {
        const audioPanel = document.querySelector('.audio-log-panel');
        const floatingBtn = document.getElementById('floating-audio-btn');

        if (audioPanel.classList.contains('hidden')) {
            audioPanel.classList.remove('hidden');
            floatingBtn.classList.remove('visible');
            showNotification('üìª Registro de audio activado', 'success');
        } else {
            audioPanel.classList.add('hidden');
            floatingBtn.classList.add('visible');
            showNotification('üìª Registro de audio oculto', 'info');
        }
    }

    window.toggleFullscreen = function () {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().then(() => {
                showNotification('üî≥ Pantalla completa activada', 'success');
            }).catch(() => {
                showNotification('‚ùå No se pudo activar pantalla completa', 'error');
            });
        } else {
            document.exitFullscreen().then(() => {
                showNotification('üî≤ Pantalla completa desactivada', 'info');
            });
        }
    }

    // CARGAR PREFERENCIAS GUARDADAS
    function loadViewPreferences() {
        const chatVisible = localStorage.getItem('chatVisible') !== 'false';
        const audioVisible = localStorage.getItem('audioVisible') !== 'false';

        // Configurar estado inicial de los paneles y botones flotantes
        const chatWindow = document.querySelector('.chat-window');
        const audioPanel = document.querySelector('.audio-log-panel');
        const floatingChatBtn = document.getElementById('floating-chat-btn');
        const floatingAudioBtn = document.getElementById('floating-audio-btn');

        if (!chatVisible) {
            chatWindow.classList.add('hidden');
            floatingChatBtn.classList.add('visible');
        }

        if (!audioVisible) {
            audioPanel.classList.add('hidden');
            floatingAudioBtn.classList.add('visible');
        }
    }

    // GUARDAR PREFERENCIAS
    function saveViewPreferences() {
        const chatVisible = !document.querySelector('.chat-window').classList.contains('hidden');
        const audioVisible = !document.querySelector('.audio-log-panel').classList.contains('hidden');

        localStorage.setItem('chatVisible', chatVisible);
        localStorage.setItem('audioVisible', audioVisible);
    }

    // SHORTCUTS DE TECLADO
    document.addEventListener('keydown', function (e) {
        // Ctrl/Cmd + H = Toggle Chat
        if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
            e.preventDefault();
            toggleChat();
        }
        // Ctrl/Cmd + J = Toggle Audio Log
        if ((e.ctrlKey || e.metaKey) && e.key === 'j') {
            e.preventDefault();
            toggleAudioLog();
        }
        // F11 = Toggle Fullscreen (funciona autom√°ticamente)
        // Escape en fullscreen funciona autom√°ticamente
    });

    // Guardar preferencias al cambiar vista
    const originalToggleChat = window.toggleChat;
    const originalToggleAudio = window.toggleAudioLog;

    window.toggleChat = function () {
        const chatWindow = document.querySelector('.chat-window');
        const wasHidden = chatWindow.classList.contains('hidden');
        
        originalToggleChat();
        saveViewPreferences();
        
        // Si el chat se est√° mostrando (no estaba oculto antes), recargar el historial
        // Esto asegura que el historial se muestre cuando se vuelve a abrir el chat
        if (wasHidden) {
            // El chat se est√° mostrando ahora
            const activeDriverItem = document.querySelector('.user-item.active');
            if (activeDriverItem) {
                const driverId = activeDriverItem.getAttribute('data-driver-id');
                const driverName = activeDriverItem.getAttribute('data-driver-name') || 
                                 activeDriverItem.querySelector('span')?.textContent ||
                                 `Conductor #${driverId}`;
                
                if (driverId && typeof loadChatHistory === 'function') {
                    console.log(`üîÑ Recargando historial al mostrar chat para conductor ${driverId}`);
                    loadChatHistory(driverId);
                }
            }
        }
    };

    window.toggleAudioLog = function () {
        originalToggleAudio();
        saveViewPreferences();
    };

    // Cargar preferencias al iniciar
    setTimeout(loadViewPreferences, 500); // Peque√±o delay para asegurar que el DOM est√© listo

    // SISTEMA DE NOTIFICACIONES
    function showNotification(message, type = 'info') {
        // Crear elemento de notificaci√≥n
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        // Estilos
        Object.assign(notification.style, {
            position: 'fixed',
            top: '20px',
            right: '20px',
            background: getNotificationColor(type),
            color: 'white',
            padding: '12px 20px',
            borderRadius: '8px',
            boxShadow: '0 4px 15px rgba(0,0,0,0.2)',
            zIndex: '9999',
            fontSize: '14px',
            fontWeight: '600',
            maxWidth: '300px',
            opacity: '0',
            transform: 'translateX(100%)',
            transition: 'all 0.3s ease'
        });

        document.body.appendChild(notification);

        // Animaci√≥n de entrada
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(0)';
        }, 100);

        // Auto-remove despu√©s de 3 segundos
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    function getNotificationColor(type) {
        switch (type) {
            case 'success': return 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
            case 'error': return 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
            case 'warning': return 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
            case 'info':
            default: return 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
        }
    }

    // Iniciar conexiones
    setupWebSocket();
    // setupAudioWebSocket(); // AHORA GLOBAL
});

    // ==================== MAPA DE GOOGLE MAPS ====================
    // Funci√≥n global para inicializar el mapa
    window.initMap = function () {
        // Centro en Guayaquil, Ecuador
        window.map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -2.1894, lng: -79.8890 },
            zoom: 13,
            styles: [
                {
                    "featureType": "all",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#242f3e" }]
                },
                {
                    "featureType": "all",
                    "elementType": "labels.text.stroke",
                    "stylers": [{ "lightness": -80 }]
                },
                {
                    "featureType": "administrative",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#746855" }]
                },
                {
                    "featureType": "poi",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#d59563" }]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry.fill",
                    "stylers": [{ "color": "#2b3544" }]
                },
                {
                    "featureType": "road",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#9ca5b3" }]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#17263c" }]
                }
            ]
        });

        // Agregar capa de tr√°fico (variable global para poder controlarla)
        window.trafficLayer = new google.maps.TrafficLayer();
        window.trafficLayer.setMap(window.map);
        window.trafficEnabled = true;

        console.log('üó∫Ô∏è Mapa de Google Maps inicializado con capa de tr√°fico activa');

        // Obtener ubicaciones iniciales
        fetchDriverLocations();

        // Actualizar cada 5 segundos
        setInterval(fetchDriverLocations, 5000);
    };

    // Funciones auxiliares globales
    function fetchDriverLocations() {
        fetch('/api/ubicaciones_taxis/')
            .then(response => response.json())
            .then(data => {
                console.log('üìç Ubicaciones recibidas:', data);
                // El backend devuelve {taxis: [...]}
                if (data.taxis && data.taxis.length > 0) {
                    updateMarkers(data.taxis);
                } else {
                    console.warn('‚ö†Ô∏è No hay taxis disponibles');
                }
            })
            .catch(error => console.error('‚ùå Error al obtener ubicaciones:', error));
    }

    function updateMarkers(taxis) {
        console.log('üó∫Ô∏è Actualizando marcadores:', taxis.length, 'taxis');

        taxis.forEach(taxi => {
            // Verificar que tenga coordenadas v√°lidas
            if (!taxi.lat || !taxi.lng) {
                console.warn('‚ö†Ô∏è Taxi sin coordenadas:', taxi);
                return;
            }

            const position = { lat: parseFloat(taxi.lat), lng: parseFloat(taxi.lng) };
            const taxiId = taxi.id;

            if (markers[taxiId]) {
                // Actualizar posici√≥n del marcador existente
                console.log('üìç Actualizando marcador:', taxi.nombre);
                markers[taxiId].setPosition(position);
            } else {
                // Crear nuevo marcador
                console.log('üìç Creando nuevo marcador:', taxi.nombre);
                const marker = new google.maps.Marker({
                    position: position,
                    map: window.map,
                    title: taxi.nombre,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    }
                });

                // InfoWindow con informaci√≥n del conductor
                const infoWindow = new google.maps.InfoWindow({
                    content: `
            <div style="padding: 10px;">
                <h3 style="margin: 0 0 5px 0; color: #333;">${taxi.nombre}</h3>
                <p style="margin: 0; color: #666;">üöï ${taxi.placa || 'Sin placa'}</p>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">
                    ${taxi.descripcion || 'Sin descripci√≥n'}
                </p>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">
                    √öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}
                </p>
            </div>
        `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers[taxiId] = marker;
            }
        });
    }

    // Funci√≥n para activar/desactivar la capa de tr√°fico
    function toggleTraffic() {
        const button = document.getElementById('traffic-toggle');
        if (window.trafficEnabled) {
            // Desactivar tr√°fico
            window.trafficLayer.setMap(null);
            window.trafficEnabled = false;
            button.textContent = 'üö¶ Tr√°fico: OFF';
            button.style.borderColor = '#9E9E9E';
            button.style.color = '#9E9E9E';
            console.log('üö¶ Capa de tr√°fico desactivada');
        } else {
            // Activar tr√°fico
            window.trafficLayer.setMap(map);
            window.trafficEnabled = true;
            button.textContent = 'üö¶ Tr√°fico: ON';
            button.style.borderColor = '#4CAF50';
            button.style.color = '#4CAF50';
            console.log('üö¶ Capa de tr√°fico activada');
        }
    }

    // DEBUGGING: Verificar archivo que se est√° cargando
    console.log('üî• TEMPLATE DEBUG: Cargando comunicacion-completa.js con timestamp:', '{{ timestamp }}');
    console.log('üìç URL completa:', "{% static 'js/comunicacion-completa.js' %}?v={{ timestamp }}");
    console.log('‚è∞ Timestamp actual:', new Date().toISOString());

    // Sistema de Comunicaci√≥n Walkie-Talkie - VERSI√ìN COMPLETA CORREGIDA
    //script src="{% static 'js/comunicacion-completa.js' %}?v={{ timestamp }}"></script>
</script>
-->
<!-- FIN SCRIPT INLINE COMENTADO -->

<!-- Sistema de Comunicaci√≥n Walkie-Talkie - VERSI√ìN COMPLETA (archivo presente en staticfiles) -->
<!-- CACHE BUSTING: Timestamp din√°mico para forzar recarga en cada despliegue -->
<script src="{% static 'js/comunicacion-completa.js' %}?v={{ timestamp }}"></script>

<!-- CONTROL DE CAPA DE TR√ÅFICO -->
<script>
// Funci√≥n para activar/desactivar la capa de tr√°fico
function toggleTraffic() {
    const button = document.getElementById('traffic-toggle');
    
    // Verificar que el mapa y la capa de tr√°fico existan
    if (!window.trafficLayer || !window.map) {
        console.error('‚ùå Mapa o capa de tr√°fico no inicializados');
        alert('El mapa a√∫n no est√° listo. Por favor espera unos segundos.');
        return;
    }
    
    if (window.trafficEnabled) {
        // Desactivar tr√°fico
        window.trafficLayer.setMap(null);
        window.trafficEnabled = false;
        button.textContent = 'üö¶ Tr√°fico: OFF';
        button.style.borderColor = '#9E9E9E';
        button.style.color = '#9E9E9E';
        console.log('üö¶ Capa de tr√°fico desactivada');
    } else {
        // Activar tr√°fico
        window.trafficLayer.setMap(window.map);
        window.trafficEnabled = true;
        button.textContent = 'üö¶ Tr√°fico: ON';
        button.style.borderColor = '#4CAF50';
        button.style.color = '#4CAF50';
        console.log('üö¶ Capa de tr√°fico activada');
    }
}
</script>

<!-- PARCHE CR√çTICO: Sobrescribir sendMessageToDriver con versi√≥n actualizada -->
<script>
console.log('üîß PARCHE CR√çTICO: Sobrescribiendo sendMessageToDriver con soporte para archivos...');

// Funci√≥n helper para obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Funci√≥n para subir archivo a Cloudinary
async function uploadChatMedia(file) {
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        // Obtener CSRF token
        const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        const response = await fetch('/api/chat/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Error subiendo archivo');
        }
        
        return data;
    } catch (error) {
        console.error('‚ùå Error subiendo archivo:', error);
        throw error;
    }
}

// Sobrescribir sendMessageToDriver con versi√≥n completa
window.sendMessageToDriver = async function(driverId, fileToSend = null) {
    const input = document.getElementById('chat-message-input');
    const fileInput = document.getElementById('chat-file-input');
    
    console.log('üîç DEBUG sendMessageToDriver (PARCHE):');
    console.log('  - driverId:', driverId);
    console.log('  - fileToSend (par√°metro):', fileToSend);
    
    // BUSCAR chatSocket - puede estar en window.chatSocket o en el scope del archivo JS
    let chatSocketToUse = window.chatSocket;
    
    // Si window.chatSocket no existe, intentar buscar en el scope global
    if (!chatSocketToUse) {
        console.log('‚ö†Ô∏è window.chatSocket no existe, buscando en otros scopes...');
        
        // Esperar un poco por si se est√° inicializando
        let attempts = 0;
        while (!window.chatSocket && attempts < 20) {
            console.log('‚è≥ Esperando... intento', attempts + 1);
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
            
            // Intentar acceder al chatSocket del archivo JS
            if (typeof chatSocket !== 'undefined') {
                chatSocketToUse = chatSocket;
                console.log('‚úÖ Encontrado chatSocket en scope global');
                break;
            }
            
            if (window.chatSocket) {
                chatSocketToUse = window.chatSocket;
                console.log('‚úÖ Encontrado window.chatSocket');
                break;
            }
        }
    } else {
        chatSocketToUse = window.chatSocket;
    }
    
    if (!chatSocketToUse) {
        console.error('‚ùå No se pudo encontrar chatSocket despu√©s de 2 segundos');
        console.error('‚ùå window.chatSocket:', window.chatSocket);
        console.error('‚ùå typeof chatSocket:', typeof chatSocket);
        alert('Error: No se pudo conectar al chat. Recarga la p√°gina.');
        return;
    }
    
    console.log('‚úÖ chatSocket encontrado:', chatSocketToUse);
    
    const message = input ? input.value.trim() : '';
    
    // Usar el archivo del par√°metro si existe, sino buscar en fileInput
    let file = fileToSend;
    if (!file && fileInput && fileInput.files.length > 0) {
        file = fileInput.files[0];
    }
    
    console.log('  - message:', message);
    console.log('  - file (final):', file);
    
    // Validar que haya mensaje o archivo
    if (!message && !file) {
        console.log('‚ùå No hay mensaje ni archivo, saliendo...');
        return;
    }
    
    console.log('üì§ Enviando mensaje a conductor:', driverId, message || '(con archivo)');

    try {
        let mediaData = null;
        let messageType = 'text';
        
        // Si hay archivo, subirlo primero
        if (file) {
            console.log('üì§ Subiendo archivo:', file.name, file.type);
            
            // Mostrar indicador de carga
            const chatLog = document.getElementById('chat-log');
            if (chatLog) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'upload-loading';
                loadingDiv.style.cssText = 'text-align: center; padding: 10px; color: #666; font-style: italic;';
                loadingDiv.textContent = '‚è≥ Subiendo archivo...';
                chatLog.appendChild(loadingDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            }
            
            try {
                mediaData = await uploadChatMedia(file);
                messageType = mediaData.message_type;
                console.log('‚úÖ Archivo subido:', mediaData.media_url);
                
                // Remover indicador de carga
                const loadingDiv = document.getElementById('upload-loading');
                if (loadingDiv) loadingDiv.remove();
            } catch (uploadError) {
                console.error('‚ùå Error subiendo archivo:', uploadError);
                
                // Remover indicador de carga
                const loadingDiv = document.getElementById('upload-loading');
                if (loadingDiv) loadingDiv.remove();
                
                // Mostrar error
                const chatLog = document.getElementById('chat-log');
                if (chatLog) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'text-align: center; padding: 10px; color: #e74c3c; font-style: italic;';
                    errorDiv.textContent = `‚ùå Error subiendo archivo: ${uploadError.message}`;
                    chatLog.appendChild(errorDiv);
                    chatLog.scrollTop = chatLog.scrollHeight;
                }
                return; // No enviar mensaje si falla la subida
            }
        }
        
        // Guardar mensaje en el historial
        if (window.addMessageToHistory && typeof window.addMessageToHistory === 'function') {
            const messageObj = {
                message: message,
                sender_name: 'Central',
                sender_id: 1,
                is_sent: true,
                timestamp: new Date().toISOString(),
                message_type: messageType,
                media_url: mediaData ? mediaData.media_url : null,
                thumbnail_url: mediaData ? mediaData.thumbnail_url : null,
                metadata: mediaData ? mediaData.metadata : {}
            };
            window.addMessageToHistory(driverId, messageObj);
            console.log('üíæ Mensaje guardado en historial');
        }
        
        // Agregar mensaje al chat log inmediatamente
        const chatLog = document.getElementById('chat-log');
        if (chatLog) {
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Construir contenido seg√∫n tipo de mensaje
            let messageContent = '';
            if (mediaData && mediaData.media_url) {
                if (messageType === 'image') {
                    messageContent = `
                        <div style="margin-bottom: 8px;">
                            <img src="${mediaData.media_url}" 
                                 style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer;"
                                 onclick="window.open('${mediaData.media_url}', '_blank')"
                                 alt="Imagen">
                        </div>
                        ${message ? `<div style="display: block; word-wrap: break-word; margin-top: 8px;">${message}</div>` : ''}
                    `;
                } else if (messageType === 'video') {
                    messageContent = `
                        <div style="margin-bottom: 8px;">
                            <video controls 
                                   style="max-width: 100%; max-height: 300px; border-radius: 8px;"
                                   poster="${mediaData.thumbnail_url || ''}">
                                <source src="${mediaData.media_url}" type="video/mp4">
                                Tu navegador no soporta videos.
                            </video>
                        </div>
                        ${message ? `<div style="display: block; word-wrap: break-word; margin-top: 8px;">${message}</div>` : ''}
                    `;
                }
            } else {
                messageContent = `<div style="display: block; word-wrap: break-word;">${message}</div>`;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            messageDiv.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; margin-bottom: 10px; padding: 8px 12px; background: #007bff; color: white; border-radius: 8px; max-width: 70%; margin-left: auto;';
            
            messageDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 4px; display: block;">Central</div>
                ${messageContent}
                <div class="message-time" style="font-size: 0.8em; opacity: 0.8; margin-top: 4px; display: block;">${timestamp}</div>
            `;
            
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
            console.log(`‚úÖ Mensaje agregado al chat log: ${message || '(con media)'}`);
        }
        
        // Enviar por WebSocket de Chat
        console.log('üîç DEBUG WebSocket:');
        console.log('  - chatSocketToUse existe?', !!chatSocketToUse);
        console.log('  - chatSocket.readyState:', chatSocketToUse?.readyState);
        console.log('  - WebSocket.OPEN:', WebSocket.OPEN);
        
        if (chatSocketToUse && chatSocketToUse.readyState === WebSocket.OPEN) {
            const wsMessage = {
                'type': 'chat_message',
                'message': message,
                'recipient_id': driverId,
                'sender_id': 'admin',
                'message_type': messageType
            };
            
            // Agregar campos de media si existen
            if (mediaData) {
                wsMessage.media_url = mediaData.media_url;
                wsMessage.thumbnail_url = mediaData.thumbnail_url;
                wsMessage.metadata = mediaData.metadata;
            }
            
            console.log('üì§ Enviando por WebSocket:', wsMessage);
            chatSocketToUse.send(JSON.stringify(wsMessage));
            console.log('‚úÖ Mensaje enviado por Chat WebSocket');
        } else {
            console.error('‚ùå Chat WebSocket NO est√° conectado!');
            console.error('  - chatSocketToUse existe?', !!chatSocketToUse);
            console.error('  - readyState:', chatSocketToUse?.readyState);
            console.error('  - Estados: CONNECTING=0, OPEN=1, CLOSING=2, CLOSED=3');
        }
        
        // Limpiar inputs
        if (input) input.value = '';
        if (fileInput) fileInput.value = '';
        
    } catch (error) {
        console.error('‚ùå Error enviando mensaje:', error);
    }
};

console.log('‚úÖ PARCHE APLICADO: sendMessageToDriver con soporte completo para archivos');
</script>

<!-- PARCHE: Interceptar mensajes recibidos para mostrar im√°genes del conductor -->
<script>
console.log('üîß PARCHE: Interceptando handleChatMessage para mostrar im√°genes del conductor...');

// Esperar a que handleChatMessage est√© disponible
setTimeout(() => {
    if (window.handleChatMessage && typeof window.handleChatMessage === 'function') {
        const originalHandleChatMessage = window.handleChatMessage;
        
        window.handleChatMessage = function(data) {
            console.log('üîç PARCHE: Mensaje de chat interceptado:', data);
            
            // Si es un mensaje con imagen del conductor, mostrarlo
            if (data.message_type === 'image' && data.media_url) {
                console.log('üì∏ PARCHE: Mensaje con imagen detectado del conductor');
                
                const chatLog = document.getElementById('chat-log');
                if (chatLog && window.currentChatDriverId && window.currentChatDriverId == data.sender_id) {
                    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const senderName = data.sender_name || `Conductor #${data.sender_id}`;
                    
                    const messageHtml = `
                        <div class="message received" style="display: block !important; margin-bottom: 10px; padding: 8px 12px; background: #e9ecef; color: black; border-radius: 8px; max-width: 70%; margin-right: auto;">
                            <div style="font-weight: bold; margin-bottom: 4px;">${senderName}</div>
                            <div style="margin-bottom: 8px;">
                                <img src="${data.media_url}" 
                                     style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer;"
                                     onclick="window.open('${data.media_url}', '_blank')"
                                     alt="Imagen">
                            </div>
                            ${data.message ? `<div style="margin-top: 8px;">${data.message}</div>` : ''}
                            <div style="font-size: 0.8em; opacity: 0.8; margin-top: 4px;">${timestamp}</div>
                        </div>
                    `;
                    
                    chatLog.insertAdjacentHTML('beforeend', messageHtml);
                    chatLog.scrollTop = chatLog.scrollHeight;
                    console.log('‚úÖ PARCHE: Imagen del conductor mostrada en el chat');
                }
            }
            
            // Llamar a la funci√≥n original
            originalHandleChatMessage.call(this, data);
        };
        
        console.log('‚úÖ PARCHE APLICADO: handleChatMessage interceptado');
    } else {
        console.warn('‚ö†Ô∏è handleChatMessage no disponible a√∫n');
    }
}, 1000);
</script>

<!-- PARCHE TEMPORAL: Sobrescribir funci√≥n para mostrar historial desde data-initial-history -->
<script>
console.log('üîß PARCHE: Sobrescribiendo openDriverChatFromList para cargar historial...');

// Guardar referencia a la funci√≥n original
const originalOpenDriverChatFromList = window.openDriverChatFromList || function() {};

// Sobrescribir con nueva implementaci√≥n
window.openDriverChatFromList = function(driverId, driverName) {
    console.log('üö® PARCHE EJECUT√ÅNDOSE: openDriverChatFromList');
    console.log('üí¨ Conductor:', driverName, 'ID:', driverId);
    
    // Llamar a la funci√≥n original primero
    if (typeof originalOpenDriverChatFromList === 'function') {
        originalOpenDriverChatFromList(driverId, driverName);
    }
    
    // Luego cargar el historial desde data-initial-history
    setTimeout(() => {
        console.log('üì¶ Intentando cargar historial desde data-initial-history...');
        
        const driverElement = document.querySelector(`[data-driver-id="${driverId}"]`);
        if (!driverElement) {
            console.warn('‚ö†Ô∏è No se encontr√≥ elemento del conductor');
            return;
        }
        
        const historyJson = driverElement.getAttribute('data-initial-history');
        if (!historyJson) {
            console.warn('‚ö†Ô∏è No hay data-initial-history');
            return;
        }
        
        console.log('üì¶ JSON encontrado, longitud:', historyJson.length);
        
        try {
            const history = JSON.parse(historyJson);
            console.log('‚úÖ Historial parseado:', history.length, 'mensajes');
            
            if (history.length === 0) {
                console.log('üì≠ Historial vac√≠o');
                return;
            }
            
            // Obtener el chat log
            const chatLog = document.getElementById('chat-log');
            if (!chatLog) {
                console.error('‚ùå No se encontr√≥ chat-log');
                return;
            }
            
            // Limpiar chat log
            chatLog.innerHTML = '';
            console.log('üßπ Chat log limpiado');
            
            // Renderizar cada mensaje
            history.forEach((msg, index) => {
                const isSent = msg.is_sent === true;
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
                messageDiv.style.cssText = `
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    margin: 10px;
                    padding: 10px;
                    border-radius: 10px;
                    max-width: 80%;
                    background-color: ${isSent ? '#007bff' : '#f1f1f1'};
                    color: ${isSent ? 'white' : '#333'};
                    ${isSent ? 'margin-left: auto;' : 'margin-right: auto;'}
                `;
                
                // Construir contenido seg√∫n tipo de mensaje
                let messageContent = '';
                
                // Si tiene media (imagen o video)
                if (msg.media_url) {
                    if (msg.message_type === 'image') {
                        messageContent = `
                            <div style="margin-bottom: 8px;">
                                <img src="${msg.media_url}" 
                                     style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer; display: block;"
                                     onclick="window.open('${msg.media_url}', '_blank')"
                                     alt="Imagen">
                            </div>
                        `;
                    } else if (msg.message_type === 'video') {
                        const posterUrl = msg.thumbnail_url || '';
                        messageContent = `
                            <div style="margin-bottom: 8px;">
                                <video controls 
                                       style="max-width: 100%; max-height: 300px; border-radius: 8px; display: block;"
                                       ${posterUrl ? `poster="${posterUrl}"` : ''}>
                                    <source src="${msg.media_url}" type="video/mp4">
                                    Tu navegador no soporta videos.
                                </video>
                            </div>
                        `;
                    }
                }
                
                // Agregar mensaje de texto si existe
                if (msg.message && msg.message.trim()) {
                    messageContent += `
                        <div style="word-wrap: break-word; ${msg.media_url ? 'margin-top: 8px;' : ''}">
                            ${msg.message}
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 4px;">
                        ${isSent ? 'T√∫' : msg.sender_name}
                    </div>
                    ${messageContent}
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 4px;">
                        ${new Date(msg.timestamp).toLocaleString()}
                    </div>
                `;
                
                chatLog.appendChild(messageDiv);
                
                if (index === 0 || index === history.length - 1) {
                    const preview = msg.media_url ? `[${msg.message_type}]` : msg.message.substring(0, 30);
                    console.log(`   ‚úÖ Mensaje ${index + 1}:`, preview);
                }
            });
            
            // Scroll al final
            chatLog.scrollTop = chatLog.scrollHeight;
            
            console.log('‚úÖ HISTORIAL RENDERIZADO:', history.length, 'mensajes mostrados');
            console.log('üìä Elementos en DOM:', chatLog.children.length);
            
        } catch (e) {
            console.error('‚ùå Error parseando historial:', e);
        }
    }, 500); // Esperar 500ms para que la funci√≥n original termine
};

console.log('‚úÖ PARCHE APLICADO: openDriverChatFromList sobrescrita');

// ==================== FUNCIONALIDAD DE ADJUNTAR ARCHIVOS ====================
// Conectar el bot√≥n de adjuntar archivos con la funcionalidad existente
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìé Configurando funcionalidad de adjuntar archivos...');
    
    const fileBtn = document.getElementById('chat-file-btn');
    const fileInput = document.getElementById('chat-file-input');
    
    if (fileBtn && fileInput) {
        // Cuando se hace clic en el bot√≥n, abrir el selector de archivos
        fileBtn.addEventListener('click', function() {
            console.log('üìé Bot√≥n de adjuntar clickeado');
            
            // Verificar que hay un conductor seleccionado
            const messageInput = document.getElementById('chat-message-input');
            const driverId = messageInput ? messageInput.getAttribute('data-driver-id') : null;
            
            if (!driverId) {
                alert('Por favor selecciona un conductor primero');
                return;
            }
            
            fileInput.click();
        });
        
        // Cuando se selecciona un archivo, mostrar preview con opci√≥n de mensaje
        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) {
                console.log('‚ö†Ô∏è No se seleccion√≥ ning√∫n archivo');
                return;
            }
            
            console.log('üìé Archivo seleccionado:', file.name, file.type, file.size);
            
            // Validar tama√±o (m√°ximo 10MB - igual que el backend)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('El archivo es demasiado grande. M√°ximo 10MB permitido.');
                fileInput.value = '';
                return;
            }
            
            // Validar tipo de archivo
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'video/mp4', 'video/webm'];
            if (!allowedTypes.includes(file.type)) {
                alert('Tipo de archivo no permitido. Solo se permiten im√°genes (JPG, PNG, GIF, WebP) y videos (MP4, WebM).');
                fileInput.value = '';
                return;
            }
            
            // Obtener ID del conductor actual
            const messageInput = document.getElementById('chat-message-input');
            const driverId = messageInput ? messageInput.getAttribute('data-driver-id') : null;
            
            if (!driverId) {
                alert('Por favor selecciona un conductor primero');
                fileInput.value = '';
                return;
            }
            
            // Crear preview del archivo
            const reader = new FileReader();
            reader.onload = function(event) {
                // Crear modal de preview
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                // Preview de la imagen/video
                let previewHTML = '';
                if (file.type.startsWith('image/')) {
                    previewHTML = `
                        <img src="${event.target.result}" 
                             style="max-width: 100%; max-height: 300px; border-radius: 8px; display: block; margin: 0 auto;">
                    `;
                } else if (file.type.startsWith('video/')) {
                    previewHTML = `
                        <video src="${event.target.result}" controls 
                               style="max-width: 100%; max-height: 300px; border-radius: 8px; display: block; margin: 0 auto;">
                        </video>
                    `;
                }
                
                content.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: #333;">Enviar archivo</h3>
                    ${previewHTML}
                    <div style="margin: 15px 0; color: #666; font-size: 14px;">
                        <strong>${file.name}</strong><br>
                        Tama√±o: ${(file.size / 1024).toFixed(2)} KB
                    </div>
                    <textarea id="file-message-input" 
                              placeholder="Agregar mensaje (opcional)..." 
                              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; 
                                     font-family: inherit; font-size: 14px; resize: vertical; min-height: 60px; box-sizing: border-box;">
                    </textarea>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button id="send-file-btn" 
                                style="flex: 1; padding: 12px; background: #007bff; color: white; border: none; 
                                       border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            üì§ Enviar
                        </button>
                        <button id="cancel-file-btn" 
                                style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; 
                                       border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Focus en el textarea
                setTimeout(() => {
                    document.getElementById('file-message-input')?.focus();
                }, 100);
                
                // Bot√≥n Enviar
                document.getElementById('send-file-btn').addEventListener('click', async function() {
                    console.log('‚úÖ Usuario confirm√≥ env√≠o del archivo');
                    console.log('üìé Verificando fileInput:', fileInput);
                    console.log('üìé Archivos en fileInput:', fileInput.files.length);
                    if (fileInput.files.length > 0) {
                        console.log('üìé Archivo:', fileInput.files[0].name, fileInput.files[0].type);
                    }
                    
                    // Obtener mensaje opcional
                    const optionalMessage = document.getElementById('file-message-input').value.trim();
                    console.log('üí¨ Mensaje opcional:', optionalMessage || '(vac√≠o)');
                    
                    if (optionalMessage) {
                        // Poner el mensaje en el input principal
                        const messageInput = document.getElementById('chat-message-input');
                        if (messageInput) {
                            messageInput.value = optionalMessage;
                            console.log('üí¨ Mensaje puesto en input principal');
                        }
                    }
                    
                    // NO cerrar modal todav√≠a - esperar a que se env√≠e el archivo
                    console.log('‚è≥ Esperando env√≠o del archivo...');
                    
                    // Enviar archivo pas√°ndolo como par√°metro
                    console.log('üì§ Verificando funci√≥n sendMessageToDriver:', typeof sendMessageToDriver);
                    if (typeof sendMessageToDriver === 'function') {
                        console.log('üì§ Llamando a sendMessageToDriver con driverId:', driverId);
                        console.log('üì§ Pasando archivo:', file ? file.name : 'null');
                        try {
                            await sendMessageToDriver(driverId, file);
                            console.log('‚úÖ sendMessageToDriver completado');
                        } catch (error) {
                            console.error('‚ùå Error en sendMessageToDriver:', error);
                        }
                        
                        // Cerrar modal DESPU√âS de enviar
                        modal.remove();
                        console.log('üö™ Modal cerrado');
                        
                        // Limpiar input de archivo DESPU√âS de enviar
                        fileInput.value = '';
                        console.log('üßπ FileInput limpiado');
                        
                        // Limpiar mensaje del input principal
                        const messageInput = document.getElementById('chat-message-input');
                        if (messageInput) {
                            messageInput.value = '';
                            console.log('üßπ Mensaje del input principal limpiado');
                        }
                    } else {
                        console.error('‚ùå Funci√≥n sendMessageToDriver no encontrada');
                        alert('Error: No se pudo enviar el archivo. Por favor recarga la p√°gina.');
                        modal.remove();
                        fileInput.value = '';
                    }
                });
                
                // Bot√≥n Cancelar
                document.getElementById('cancel-file-btn').addEventListener('click', function() {
                    console.log('‚ùå Usuario cancel√≥ env√≠o del archivo');
                    modal.remove();
                    fileInput.value = '';
                });
                
                // Cerrar al hacer clic fuera del contenido
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        console.log('‚ùå Usuario cerr√≥ el modal');
                        modal.remove();
                        fileInput.value = '';
                    }
                });
            };
            
            reader.readAsDataURL(file);
        });
        
        console.log('‚úÖ Funcionalidad de adjuntar archivos configurada');
    } else {
        console.warn('‚ö†Ô∏è No se encontraron elementos de adjuntar archivos');
        if (!fileBtn) console.warn('  - chat-file-btn no encontrado');
        if (!fileInput) console.warn('  - chat-file-input no encontrado');
    }
});
</script>

{% endblock %}