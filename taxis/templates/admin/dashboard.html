{% extends 'admin/base_admin.html' %}

{% block title %}Dashboard - Panel de Administración{% endblock %}
{% block page_title %}Dashboard Principal{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard Principal</h1>
    <p>Resumen general del sistema multi-tenant</p>
</div>

<!-- Estadísticas Principales -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card primary">
            <div class="icon">
                <i class="fas fa-building"></i>
            </div>
            <h3>{{ total_organizations }}</h3>
            <p>Cooperativas Activas</p>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card success">
            <div class="icon">
                <i class="fas fa-user-check"></i>
            </div>
            <h3>{{ total_drivers }}</h3>
            <p>Conductores Aprobados</p>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="icon">
                <i class="fas fa-clock"></i>
            </div>
            <h3>{{ pending_drivers }}</h3>
            <p>Conductores Pendientes</p>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card danger">
            <div class="icon">
                <i class="fas fa-car"></i>
            </div>
            <h3>{{ rides_this_month }}</h3>
            <p>Carreras Este Mes</p>
        </div>
    </div>
</div>

<!-- Ingresos del Mes -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="stat-card primary">
            <div class="icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <h3>${{ revenue_this_month|floatformat:2 }}</h3>
            <p>Ingresos Totales del Mes</p>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="stat-card success">
            <div class="icon">
                <i class="fas fa-percentage"></i>
            </div>
            <h3>${{ commission_this_month|floatformat:2 }}</h3>
            <p>Comisiones del Mes</p>
        </div>
    </div>
</div>

<!-- Cooperativas Recientes -->
<div class="table-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-building me-2"></i>Cooperativas Recientes</h5>
        <a href="{% url 'admin_organizations' %}" class="btn btn-sm btn-primary">
            Ver Todas <i class="fas fa-arrow-right ms-1"></i>
        </a>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Plan</th>
                    <th>Conductores</th>
                    <th>Estado</th>
                    <th>Fecha Creación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for org in recent_organizations %}
                <tr>
                    <td>
                        <strong>{{ org.name }}</strong><br>
                        <small class="text-muted">{{ org.city }}</small>
                    </td>
                    <td>
                        <span class="badge bg-info">{{ org.get_plan_display }}</span>
                    </td>
                    <td>
                        <i class="fas fa-users me-1"></i>
                        {{ org.users.filter.count }} / {{ org.max_drivers }}
                    </td>
                    <td>
                        {% if org.is_active %}
                            <span class="badge bg-success">Activo</span>
                        {% else %}
                            <span class="badge bg-danger">Suspendido</span>
                        {% endif %}
                    </td>
                    <td>{{ org.created_at|date:"d/m/Y" }}</td>
                    <td>
                        <a href="{% url 'admin_organization_detail' org.pk %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No hay cooperativas registradas
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Conductores Pendientes -->
{% if pending_drivers_list %}
<div class="table-card mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-user-clock me-2"></i>Conductores Pendientes de Aprobación</h5>
        <a href="{% url 'admin_drivers_pending' %}" class="btn btn-sm btn-warning">
            Ver Todos ({{ pending_drivers }}) <i class="fas fa-arrow-right ms-1"></i>
        </a>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Conductor</th>
                    <th>Cooperativa</th>
                    <th>Email</th>
                    <th>Teléfono</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for driver in pending_drivers_list %}
                <tr>
                    <td>
                        <strong>{{ driver.get_full_name }}</strong><br>
                        <small class="text-muted">{{ driver.username }}</small>
                    </td>
                    <td>{{ driver.organization.name|default:"Sin asignar" }}</td>
                    <td>{{ driver.email }}</td>
                    <td>{{ driver.phone_number|default:"-" }}</td>
                    <td>{{ driver.date_joined|date:"d/m/Y H:i" }}</td>
                    <td>
                        <form method="post" action="{% url 'admin_driver_approve' driver.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success" title="Aprobar">
                                <i class="fas fa-check"></i>
                            </button>
                        </form>
                        <button type="button" class="btn btn-sm btn-danger" title="Rechazar" 
                                data-bs-toggle="modal" data-bs-target="#rejectModal{{ driver.pk }}">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Estadísticas por Plan -->
<div class="row g-4 mt-4">
    <div class="col-md-12">
        <div class="table-card">
            <h5><i class="fas fa-chart-pie me-2"></i>Distribución por Plan</h5>
            <div class="row mt-3">
                {% for stat in stats_by_plan %}
                <div class="col-md-3">
                    <div class="text-center p-3 border rounded">
                        <h4>{{ stat.count }}</h4>
                        <p class="mb-1">{{ stat.plan|upper }}</p>
                        <small class="text-muted">{{ stat.total_drivers }} conductores</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Facturas Pendientes -->
{% if pending_invoices %}
<div class="table-card mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-file-invoice-dollar me-2"></i>Facturas Pendientes</h5>
        <a href="{% url 'admin_invoices' %}" class="btn btn-sm btn-primary">
            Ver Todas <i class="fas fa-arrow-right ms-1"></i>
        </a>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Número</th>
                    <th>Cooperativa</th>
                    <th>Período</th>
                    <th>Monto</th>
                    <th>Vencimiento</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in pending_invoices %}
                <tr>
                    <td><strong>{{ invoice.invoice_number }}</strong></td>
                    <td>{{ invoice.organization.name }}</td>
                    <td>{{ invoice.period_start|date:"d/m/Y" }} - {{ invoice.period_end|date:"d/m/Y" }}</td>
                    <td>${{ invoice.total_amount|floatformat:2 }}</td>
                    <td>
                        {% if invoice.is_overdue %}
                            <span class="badge bg-danger">Vencida</span>
                        {% else %}
                            {{ invoice.due_date|date:"d/m/Y" }}
                        {% endif %}
                    </td>
                    <td>
                        <form method="post" action="{% url 'admin_invoice_mark_paid' invoice.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success" title="Marcar como pagada">
                                <i class="fas fa-check-circle"></i> Pagada
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh cada 5 minutos
    setTimeout(function() {
        location.reload();
    }, 300000);
</script>
{% endblock %}
