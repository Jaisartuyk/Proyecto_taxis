{% extends 'base.html' %}
{% load static %}

{% block title %}Central de Comunicación{% endblock %}

{% block content %}
<style>
    /* === DISEÑO PROFESIONAL CENTRO DE COMANDO === */
    body {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    /* Sobrescribir estilos del contenedor principal de base.html */
    .container, .container-fluid {
        background: transparent !important;
        padding: 0 !important;
        max-width: 100% !important;
    }

    .command-center-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #fff;
        padding: 20px 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid #0f3460;
    }

    .command-center-header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .command-center-header h1::before {
        content: "🚕";
        font-size: 2rem;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.1);
        padding: 10px 20px;
        border-radius: 25px;
        backdrop-filter: blur(10px);
    }

    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4CAF50;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }

    .main-layout {
        display: flex;
        height: calc(100vh - 80px);
        gap: 0;
        flex-direction: column;
    }

    .map-container {
        height: 250px;
        width: 100%;
        border-bottom: 3px solid #0f3460;
        position: relative;
        flex-shrink: 0;
        max-height: 250px;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .content-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
        min-height: 0;
    }

    .chat-container {
        display: flex;
        flex: 1;
        background: #fff;
        border-radius: 0;
        box-shadow: none;
        overflow: hidden;
        margin: 0;
        min-height: 400px;
    }

    .audio-log-panel {
        width: 300px;
        background: linear-gradient(180deg, #16213e 0%, #0f1419 100%);
        border-left: 2px solid #0f3460;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .audio-log-header {
        padding: 20px;
        background: rgba(15, 52, 96, 0.5);
        color: #fff;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.9rem;
        border-bottom: 2px solid #0f3460;
    }

    .audio-log-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .audio-log-item {
        background: rgba(255,255,255,0.05);
        border-left: 3px solid #4CAF50;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        animation: slideInRight 0.3s ease;
    }

    .audio-log-item.sent {
        border-left-color: #667eea;
    }

    .audio-log-item.received {
        border-left-color: #4CAF50;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .audio-log-sender {
        color: #fff;
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .audio-log-sender::before {
        content: "🎤";
        font-size: 1rem;
    }

    .audio-log-time {
        color: rgba(255,255,255,0.5);
        font-size: 0.75rem;
    }

    .audio-log-empty {
        color: rgba(255,255,255,0.3);
        text-align: center;
        padding: 40px 20px;
        font-size: 0.9rem;
    }

    .user-list {
        width: 30%;
        max-width: 350px;
        border-right: 2px solid #0f3460;
        overflow-y: auto;
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
    }

    .user-list-header {
        padding: 20px;
        font-size: 1.1rem;
        font-weight: 700;
        border-bottom: 2px solid #0f3460;
        background: rgba(15, 52, 96, 0.5);
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .chat-header {
        padding: 20px;
        font-size: 1.2rem;
        font-weight: 600;
        border-bottom: 2px solid #e0e0e0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        transition: all 0.3s ease;
        color: #fff;
        position: relative;
    }

    .user-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: #4CAF50;
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }

    .user-item:hover {
        background-color: rgba(102, 126, 234, 0.2);
        transform: translateX(5px);
    }

    .user-item:hover::before,
    .user-item.active::before {
        transform: scaleY(1);
    }

    .user-item.active {
        background-color: rgba(102, 126, 234, 0.3);
        border-left: 3px solid #4CAF50;
    }

    .user-item img {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 15px;
        border: 2px solid rgba(255,255,255,0.3);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .chat-window {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        flex-shrink: 0;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: linear-gradient(180deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    .message {
        display: flex;
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.sent {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        text-align: right;
        border-bottom-right-radius: 4px;
    }

    .message.received {
        background: #fff;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 4px;
        border-left: 3px solid #667eea;
    }

    .message-sender {
        font-size: 0.8rem;
        color: #888;
        margin: 0 5px 5px 5px;
    }

    .chat-input-area {
        display: flex;
        padding: 15px;
        border-top: 2px solid #e0e0e0;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        gap: 10px;
        align-items: center;
    }

    #chat-message-input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 25px;
        outline: none;
        font-size: 14px;
        background: rgba(255,255,255,0.9);
        transition: all 0.3s ease;
    }

    #chat-message-input:focus {
        border-color: #667eea;
        background: #fff;
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
    }

    #chat-message-submit {
        padding: 12px 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    #chat-message-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    #no-chat-selected {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #667eea;
        font-size: 1.2rem;
        font-weight: 600;
        flex-direction: column;
        gap: 15px;
    }

    #no-chat-selected::before {
        content: "💬";
        font-size: 4rem;
        opacity: 0.5;
    }
</style>

<!-- HEADER DEL CENTRO DE COMANDO -->
<div class="command-center-header">
    <h1>Central de Control - De Aquí Pa'llá</h1>
    <div class="status-indicator">
        <div class="status-dot"></div>
        <span>Sistema Activo</span>
    </div>
</div>

<div class="main-layout">
<!-- MAPA DE UBICACIONES EN TIEMPO REAL -->
<div class="map-container">
    <div id="map"></div>
</div>

<div class="content-layout">
<div class="chat-container">
    {% if request.user.is_superuser %}
    <div class="user-list">
        <div class="user-list-header">Conductores</div>
        {% for driver in drivers %}
        <div class="user-item" data-driver-id="{{ driver.id }}" data-driver-name="{{ driver.get_full_name }}">
            <img src="{{ driver.profile_picture.url|default:'/static/imagenes/logo1.png' }}" alt="{{ driver.get_full_name }}">
            <span>{{ driver.get_full_name }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="chat-window">
        <div class="chat-header" id="chat-header">Selecciona un chat</div>
        <div class="chat-messages" id="chat-log">
            <div id="no-chat-selected">Selecciona una conversación para comenzar</div>
        </div>
        <div class="chat-input-area" id="chat-input-container" style="display: none;">
            <button id="record-audio-btn" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; user-select: none; font-size: 24px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;">🎤</button>
            <div style="display: flex; flex-direction: column; margin-right: 15px;">
                <small style="color: #fff; font-weight: 600;">Push-To-Talk</small>
                <small style="color: rgba(255,255,255,0.7); font-size: 11px;">Mantén presionado</small>
            </div>
            <input id="chat-message-input" type="text" placeholder="Escribe un mensaje...">
            <button id="chat-message-submit">Enviar</button>
        </div>
    </div>
</div>

<!-- PANEL DE REGISTRO DE AUDIO -->
<div class="audio-log-panel">
    <div class="audio-log-header">
        📻 Registro de Audio
    </div>
    <div class="audio-log-content" id="audio-log">
        <div class="audio-log-empty">
            No hay comunicaciones de audio aún
        </div>
    </div>
</div>
</div> <!-- Cierre content-layout -->
</div> <!-- Cierre main-layout -->

<audio id="audio-player" style="display: none;"></audio>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentUser = {
        id: "{{ request.user.id }}",
        is_superuser: {{ request.user.is_superuser|yesno:'true,false' }}
    };
    const adminUserId = "{{ admin_user_id }}";

    const chatLog = document.getElementById('chat-log');
    const chatHeader = document.getElementById('chat-header');
    const messageInput = document.getElementById('chat-message-input');
    const messageSubmit = document.getElementById('chat-message-submit');
    const inputContainer = document.getElementById('chat-input-container');
    const noChatSelected = document.getElementById('no-chat-selected');
    const audioLogPanel = document.getElementById('audio-log');

    let activeChatRecipientId = null;
    let chatSocket = null;

    // Función para agregar entrada al registro de audio
    function addAudioLogEntry(senderName, type) {
        const emptyMsg = audioLogPanel.querySelector('.audio-log-empty');
        if (emptyMsg) emptyMsg.remove();

        const logItem = document.createElement('div');
        logItem.className = `audio-log-item ${type}`;
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        logItem.innerHTML = `
            <div class="audio-log-sender">${senderName}</div>
            <div class="audio-log-time">${timeStr}</div>
        `;
        
        audioLogPanel.insertBefore(logItem, audioLogPanel.firstChild);
        
        // Mantener solo los últimos 20 registros
        const items = audioLogPanel.querySelectorAll('.audio-log-item');
        if (items.length > 20) {
            items[items.length - 1].remove();
        }
    }

    function setupWebSocket() {
        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const wsPath = wsProtocol + window.location.host + '/ws/chat/';
        
        chatSocket = new WebSocket(wsPath);

        chatSocket.onopen = function(e) {
            console.log('Chat WebSocket conectado.');
        };

        chatSocket.onclose = function(e) {
            console.error('Chat WebSocket desconectado. Reintentando en 5s...');
            setTimeout(setupWebSocket, 5000);
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const { message, sender_id, sender_name } = data;

            // Solo mostrar el mensaje si es parte de la conversación activa
            if (sender_id == activeChatRecipientId || sender_id == currentUser.id) {
                appendMessage(message, sender_id, sender_name);
            }
        };
    }

    function appendMessage(message, sender_id, sender_name) {
        if (noChatSelected) noChatSelected.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        const isSent = sender_id == currentUser.id;
        messageDiv.classList.add(isSent ? 'sent' : 'received');

        messageDiv.innerHTML = `
            <div>
                <div class="message-sender">${isSent ? 'Tú' : sender_name}</div>
                <div class="message-bubble">${message}</div>
            </div>
        `;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && activeChatRecipientId && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': message,
                'recipient_id': activeChatRecipientId
            }));
            messageInput.value = '';
        }
    }

    messageSubmit.addEventListener('click', sendMessage);
    messageInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Lógica para el admin: seleccionar un chat
    if (currentUser.is_superuser) {
        document.querySelectorAll('.user-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                activeChatRecipientId = this.dataset.driverId;
                chatHeader.textContent = `Chat con ${this.dataset.driverName}`;
                inputContainer.style.display = 'flex';
                chatLog.innerHTML = ''; // Limpiar chat anterior
                if (noChatSelected) noChatSelected.style.display = 'none';
            });
        });
    }

    // Lógica para el conductor: iniciar chat con el admin
    if (!currentUser.is_superuser) {
        activeChatRecipientId = adminUserId;
        chatHeader.textContent = 'Chat con la Central';
        inputContainer.style.display = 'flex';
        if (noChatSelected) noChatSelected.style.display = 'none';
    }

    // ==================== FUNCIONALIDAD DE AUDIO ====================
    let mediaRecorder;
    let audioChunks = [];
    let audioSocket = null;
    const recordBtn = document.getElementById('record-audio-btn');
    const audioPlayer = document.getElementById('audio-player');

    // Configurar WebSocket de audio
    function setupAudioWebSocket() {
        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const wsPath = wsProtocol + window.location.host + '/ws/audio/conductores/';
        
        audioSocket = new WebSocket(wsPath);

        audioSocket.onopen = function(e) {
            console.log('🔊 Audio WebSocket conectado');
        };

        audioSocket.onclose = function(e) {
            console.error('🔊 Audio WebSocket desconectado. Reintentando en 5s...');
            setTimeout(setupAudioWebSocket, 5000);
        };

        audioSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // Solo procesar mensajes de audio (ignorar ubicaciones)
            if (data.type !== 'audio_broadcast') {
                return;
            }
            
            console.log('🔊 Mensaje de audio recibido completo:', data);
            console.log('🔍 Mi ID:', currentUser.id, 'Sender ID:', data.senderId, 'Tipo:', typeof data.senderId);
            
            // Manejar audio de conductores
            if (data.audio) {
                // No reproducir mi propio audio (comparar por ID de usuario - ambos como string)
                const myId = String(currentUser.id);
                const senderId = String(data.senderId);
                
                if (senderId === myId) {
                    console.log('🔇 Audio propio ignorado - Mi ID:', myId, 'Sender:', senderId);
                    return;
                }
                
                console.log('✅ Audio de otra persona - reproduciendo');
                
                const audioData = 'data:audio/webm;base64,' + data.audio;
                audioPlayer.src = audioData;
                audioPlayer.play();
                
                const senderName = data.senderRole === 'Central' ? 'Otra Central' : (data.senderId || 'Conductor');
                appendAudioMessage(senderName, false);
                
                // Agregar al registro de audio
                addAudioLogEntry(`📥 ${senderName}`, 'received');
                console.log('🔊 Audio reproduciendo de:', senderName);
            }
        };
    }

    // WALKIE-TALKIE: Mantener presionado para hablar
    let audioStream = null;

    // Inicializar micrófono al cargar
    async function initMicrophone() {
        try {
            audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(audioStream);
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                sendAudioMessage(audioBlob);
                audioChunks = [];
            };
            
            console.log('🎤 Micrófono listo');
        } catch (error) {
            console.error('Error al acceder al micrófono:', error);
            alert('No se pudo acceder al micrófono. Verifica los permisos.');
        }
    }

    // Mousedown: Empezar a grabar
    recordBtn.addEventListener('mousedown', function() {
        if (mediaRecorder && mediaRecorder.state === 'inactive') {
            audioChunks = [];
            mediaRecorder.start();
            recordBtn.style.backgroundColor = '#FF5722';
            recordBtn.style.transform = 'scale(1.1)';
            console.log('🎙️ Grabando... (suelta para enviar)');
        }
    });

    // Mouseup: Detener y enviar
    recordBtn.addEventListener('mouseup', function() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            recordBtn.style.backgroundColor = '#4CAF50';
            recordBtn.style.transform = 'scale(1)';
            console.log('📤 Enviando audio...');
        }
    });

    // Mouseleave: Si sale del botón mientras graba, detener
    recordBtn.addEventListener('mouseleave', function() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            recordBtn.style.backgroundColor = '#4CAF50';
            recordBtn.style.transform = 'scale(1)';
            console.log('📤 Enviando audio...');
        }
    });

    // Touch para móviles
    recordBtn.addEventListener('touchstart', function(e) {
        e.preventDefault();
        if (mediaRecorder && mediaRecorder.state === 'inactive') {
            audioChunks = [];
            mediaRecorder.start();
            recordBtn.style.backgroundColor = '#FF5722';
            recordBtn.style.transform = 'scale(1.1)';
            console.log('🎙️ Grabando... (suelta para enviar)');
        }
    });

    recordBtn.addEventListener('touchend', function(e) {
        e.preventDefault();
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            recordBtn.style.backgroundColor = '#4CAF50';
            recordBtn.style.transform = 'scale(1)';
            console.log('📤 Enviando audio...');
        }
    });

    // Inicializar micrófono
    initMicrophone();

    // Enviar audio por WebSocket
    function sendAudioMessage(audioBlob) {
        const reader = new FileReader();
        reader.onloadend = function() {
            const base64Audio = reader.result.split(',')[1];
            if (audioSocket && audioSocket.readyState === WebSocket.OPEN) {
                audioSocket.send(JSON.stringify({
                    'type': 'central_audio_message',
                    'audio': base64Audio,
                    'senderId': currentUser.id,  // ID del usuario admin
                    'senderRole': 'Central'
                }));
                console.log('📤 Audio enviado a conductores con ID:', currentUser.id);
                appendAudioMessage('Tú (Central)', true);
                
                // Agregar al registro de audio
                addAudioLogEntry('📤 Tú (Central)', 'sent');
            } else {
                console.error('Audio WebSocket no está conectado');
                alert('No se puede enviar audio. WebSocket desconectado.');
            }
        };
        reader.readAsDataURL(audioBlob);
    }

    // Agregar mensaje de audio al chat
    function appendAudioMessage(senderName, isSent) {
        if (noChatSelected) noChatSelected.style.display = 'none';
        
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(isSent ? 'sent' : 'received');

        messageDiv.innerHTML = `
            <div>
                <div class="message-sender">${senderName}</div>
                <div class="message-bubble">🔊 Mensaje de audio</div>
            </div>
        `;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Iniciar conexiones
    setupWebSocket();
    setupAudioWebSocket();
});

// ==================== MAPA DE GOOGLE MAPS ====================
let map;
let markers = {};

function initMap() {
        // Centro en Guayaquil, Ecuador
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -2.1894, lng: -79.8890 },
            zoom: 13,
            styles: [
                {
                    "featureType": "all",
                    "elementType": "geometry",
                    "stylers": [{"color": "#242f3e"}]
                },
                {
                    "featureType": "all",
                    "elementType": "labels.text.stroke",
                    "stylers": [{"lightness": -80}]
                },
                {
                    "featureType": "administrative",
                    "elementType": "labels.text.fill",
                    "stylers": [{"color": "#746855"}]
                },
                {
                    "featureType": "poi",
                    "elementType": "labels.text.fill",
                    "stylers": [{"color": "#d59563"}]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry.fill",
                    "stylers": [{"color": "#2b3544"}]
                },
                {
                    "featureType": "road",
                    "elementType": "labels.text.fill",
                    "stylers": [{"color": "#9ca5b3"}]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [{"color": "#17263c"}]
                }
            ]
        });
        
        console.log('🗺️ Mapa de Google Maps inicializado');
        
        // Obtener ubicaciones iniciales
        fetchDriverLocations();
        
        // Actualizar cada 5 segundos
        setInterval(fetchDriverLocations, 5000);
    }

    function fetchDriverLocations() {
        fetch('/api/ubicaciones_taxis/')
            .then(response => response.json())
            .then(data => {
                console.log('📍 Ubicaciones recibidas:', data);
                updateMarkers(data);
            })
            .catch(error => console.error('Error al obtener ubicaciones:', error));
    }

    function updateMarkers(locations) {
        locations.forEach(location => {
            const position = { lat: location.latitude, lng: location.longitude };
            
            if (markers[location.driver_id]) {
                // Actualizar posición del marcador existente
                markers[location.driver_id].setPosition(position);
            } else {
                // Crear nuevo marcador
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: location.driver_name,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    }
                });
                
                // InfoWindow con información del conductor
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 5px 0; color: #333;">${location.driver_name}</h3>
                            <p style="margin: 0; color: #666;">🚕 Conductor</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">
                                Última actualización: ${new Date().toLocaleTimeString()}
                            </p>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                
                markers[location.driver_id] = marker;
            }
        });
}
</script>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=initMap" async defer></script>

{% endblock %}
